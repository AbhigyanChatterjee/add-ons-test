import{r as o}from"./text-aspect-ratio.758caee0.js";import{a as n,p as r}from"./cargo-kit-index.fa0641a8.js";const h="SUBSTANCE_EFFECT_INDEX";class i{constructor(t=()=>{}){this._state={versionUID:"",items:{}},this.stringifiedState="",this.ready=!1,this.onReadyCallback=t,this.hydrateFromStorageService().then(()=>{this.ready=!0,this.onReadyCallback(this.state)})}static getTagsFromSubstanceJson(t){return t.tags||[]}static getAuthorFromSubstanceJson(t){return t.authorName||""}static getNameFromSubstanceJson(t){return t.name||""}static getThumbnailsFromSubstanceJson(t){return[t.thumbnail,...t.presets]}static generateSubstanceMetadataFromSubstanceJson(t){return{thumbnails:i.getThumbnailsFromSubstanceJson(t),author:i.getAuthorFromSubstanceJson(t),name:i.getNameFromSubstanceJson(t),created:Date.now(),modified:Date.now(),tags:i.getTagsFromSubstanceJson(t)}}async hydrateFromStorageService(){const t=await n(h);this._state=t,this.dirtyState()}async saveStateToStorageService(){return await r(this.state,h)}async conflictRobustStateMutationExecution(t){let e=0,a=!1;for(this.ready=!1,await this.hydrateFromStorageService();!a&&e<10;){const s=o();this._state.versionUID=s,t(),this.dirtyState(),await this.saveStateToStorageService(),await this.hydrateFromStorageService(),this._state.versionUID!==s?a=!1:a=!0,e+=1}return this.ready=!0,this.onReadyCallback(this.state),!!a}async create(t,e){const a=e||o(),s=i.generateSubstanceMetadataFromSubstanceJson(t);await r(t,a),await this.conflictRobustStateMutationExecution(()=>{this._state.items[a]=s}),console.info("CREATE",a)}async read(t){const e=await n(t);return this._state.items.hasOwnProperty(t)===!1&&await this.create(e,t),console.info("READ",t),e}async update(t,e){if(this._state.items.hasOwnProperty(t)===!1){await this.create(e,t);return}const a=this._state.items[t],s=i.generateSubstanceMetadataFromSubstanceJson(e);s.created=a.created,await r(e,t),await this.conflictRobustStateMutationExecution(()=>{this._state.items[t]=s}),console.info("UPDATE",t)}async delete(t){await this.conflictRobustStateMutationExecution(()=>{delete this._state.items[t]}),console.info("DELETE",t)}dirtyState(){this.stringifiedState=""}stringify(){return this.stringifiedState||(this.stringifiedState=JSON.stringify(this._state)),this.stringifiedState}get state(){return JSON.parse(this.stringify())}}export{i as S};
