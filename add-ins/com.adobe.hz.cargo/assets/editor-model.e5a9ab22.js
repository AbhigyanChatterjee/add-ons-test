import{M as b,D as ut}from"./renderer-artboard.4485a40b.js";import{t as Q,r as j}from"./text-aspect-ratio.758caee0.js";import{g as lt,u as ht}from"./cargo-kit-index.fa0641a8.js";function te(l){let t=!1;function e(){t=!1,l()}return function(){t||(t=!0,window.requestAnimationFrame(e))}}class x{static radians(t){return t*Math.PI/180}static degrees(t){return t*180/Math.PI}static slope(t,e){return(e.y-t.y)/(e.x-t.x)}static degreesBetweenPoints(t,e){return Math.atan2(e.y-t.y,e.x-t.x)*180/Math.PI}static radiansBetweenPoints(t,e){return this.radians(this.degreesBetweenPoints(t,e))}static vectorBetweenPoints(t,e){return{x:t.x-e.x,y:t.y-e.y}}static rotatePoint(t,e,s={x:0,y:0}){const o=Math.cos(e)*(t.x-s.x)-Math.sin(e)*(t.y-s.y)+s.x,n=Math.sin(e)*(t.x-s.x)+Math.cos(e)*(t.y-s.y)+s.y;return{x:o,y:n}}static screenCoordinateToDocumentCoordinate(t,e,s,o,n){const a={x:-o/s,y:-n/s},i={x:t/s,y:e/s};return{x:a.x+i.x,y:a.y+i.y}}static distance(t,e){const s=t.x-e.x,o=t.y-e.y;return Math.sqrt(s*s+o*o)}static distanceSquared(t,e){return(t.x-e.x)**2+(t.y-e.y)**2}static closestPointOfLineToAPoint(t,e,s){const o=((t.x-e.x)*(s.x-e.x)+(t.y-e.y)*(s.y-e.y))/x.distanceSquared(e,s);return{x:e.x+o*(s.x-e.x),y:e.y+o*(s.y-e.y)}}static isPointWithinRectangle({x:t,y:e},s,o){return t>s.x&&t<o.x&&e>s.y&&e<o.y}static doRectanglesIntersect(t,e){const s=[t,e];let o,n,a,i,d,c,u,h,y,p,r,f,m;for(u=0;u<s.length;u+=1)for(o=s[u],h=0;h<o.length/2;h+=1){for(y=(h+1)%o.length,a=o[h],i=o[y],n={x:i.y-a.y,y:a.x-i.x},m=[],p=0;p<t.length;p+=1)m.push(n.x*t[p].x+n.y*t[p].y);for(d=Math.min(...m),c=Math.max(...m),m=[],p=0;p<e.length;p+=1)m.push(n.x*e[p].x+n.y*e[p].y);if(r=Math.min(...m),f=Math.max(...m),c<r||f<d)return!1}return!0}}class pt{constructor(){this.history=[],this.head=-1}get canUndo(){return this.head>0}get canRedo(){return this.head+1<this.history.length}save(t){this.history.push(t),this.head=this.history.length-1}undo(){return this.history.length===0?"":(this.head=Math.max(0,this.head-1),this.history[this.head])}redo(){return this.history.length===0?"":(this.head=Math.min(this.history.length-1,this.head+1),this.history[this.head])}}const ft=(l,t)=>{let e=null;return(...o)=>{e!==null&&(clearTimeout(e),e=null),e=setTimeout(()=>l(...o),t)}},mt=["Futura","FuturaBold","Courier New","Courier New Bold","Adobe Clean"],yt=[50,75,100,120],gt=[50,100,120,150,175,200,250,300],bt=["Hello","Customize Me","Example","Edit Me","Sample"],St=["F0F8FF","FAEBD7","00FFFF","7FFFD4","F0FFFF","F5F5DC","FFE4C4","000000","FFEBCD","0000FF","8A2BE2","A52A2A","DEB887","5F9EA0","7FFF00","D2691E","FF7F50","6495ED","FFF8DC","DC143C","00FFFF","00008B","008B8B","B8860B","A9A9A9","A9A9A9","006400","BDB76B","8B008B","556B2F","FF8C00","9932CC","8B0000","E9967A","8FBC8F","483D8B","2F4F4F","2F4F4F","00CED1","9400D3","FF1493","00BFFF","696969","696969","1E90FF","B22222","FFFAF0","228B22","FF00FF","DCDCDC","F8F8FF","FFD700","DAA520","808080","808080","008000","ADFF2F","F0FFF0","FF69B4","CD5C5C","4B0082","FFFFF0","F0E68C","E6E6FA","FFF0F5","7CFC00","FFFACD","ADD8E6","F08080","E0FFFF","FAFAD2","D3D3D3","D3D3D3","90EE90","FFB6C1","FFA07A","20B2AA","87CEFA","778899","778899","B0C4DE","FFFFE0","00FF00","32CD32","FAF0E6","FF00FF","800000","66CDAA","0000CD","BA55D3","9370DB","3CB371","7B68EE","00FA9A","48D1CC","C71585","191970","F5FFFA","FFE4E1","FFE4B5","FFDEAD","000080","FDF5E6","808000","6B8E23","FFA500","FF4500","DA70D6","EEE8AA","98FB98","AFEEEE","DB7093","FFEFD5","FFDAB9","CD853F","FFC0CB","DDA0DD","B0E0E6","800080","663399","FF0000","BC8F8F","4169E1","8B4513","FA8072","F4A460","2E8B57","FFF5EE","A0522D","C0C0C0","87CEEB","6A5ACD","708090","708090","FFFAFA","00FF7F","4682B4","D2B48C","008080","D8BFD8","FF6347","40E0D0","EE82EE","F5DEB3","FFFFFF","F5F5F5","FFFF00","9ACD32"],xt=[{url:"bird.jpg",width:725,height:1e3},{url:"modern-room.jpg",width:1152,height:1730},{url:"shadows.jpg",width:1288,height:1940}],vt=[.2,.3,.4];function T(l){return l[Math.floor(Math.random()*l.length)]}class Z{static get color(){return T(St)}static get placement(){return T(gt)}static get fontId(){return T(mt)}static get text(){return T(bt)}static get fontSize(){return T(yt)}static get imageData(){return T(xt)}static get imageScale(){return T(vt)}}function ee(l,t={}){l.dispatchEvent(new CustomEvent("documentEvent",{bubbles:!0,cancelable:!0,composed:!0,detail:t}))}function Ft(l){const t=atob(l.split(",")[1]),e=l.split(",")[0].split(":")[1].split(";")[0],s=new ArrayBuffer(t.length),o=new Uint8Array(s);for(let n=0;n<t.length;n++)o[n]=t.charCodeAt(n);return new Blob([s],{type:e})}function Mt(l){const t=new FileReader;return new Promise((e,s)=>{t.onerror=()=>{t.abort(),s(new DOMException("Problem parsing input file."))},t.onload=()=>{e(t.result)},t.readAsDataURL(l)})}async function wt(l){const e=await(await fetch(l)).blob();return await Mt(e)}const Nt=l=>new Promise((t,e)=>{const s=new Image;s.onload=t,s.onerror=e,s.src=l}),q="https://substance-api-int-eastus.azcloud.prod.substance3d.io",ot=`${q}/tempfiles`,tt=10;function _t(l){const t=new FileReader;return new Promise((e,s)=>{t.onerror=()=>{t.abort(),s(new DOMException("Problem parsing input file."))},t.onload=()=>{e(t.result)},t.readAsDataURL(l)})}const W=new Map,J=new Map,X=new Map;async function It(l){const s=(await(await fetch(l)).json()).file,n=await(await fetch(s)).blob(),a=new File([n],"file.sbsar",{type:"application/vnd.adobe.sbsar"}),i=new FormData;i.append("files",a,"file.sbsar");const c=await(await fetch(ot,{method:"POST",body:i})).json();return console.info(c),c.id}async function Dt(l,t){const s=t.split(";")[0].split(":")[1].split("/")[1],n=await(await fetch(t)).blob(),a=new FormData;return a.append("files",n,`${l}.${s}`),(await(await fetch(ot,{method:"POST",body:a})).json()).id}async function at(l){return W.has(l)||W.set(l,It(l)),W.get(l)}async function Et(l){const t=await at(l);return t?await(await fetch(`${q}/substances/file:${t}`)).json():{}}async function Tt(l){return l?(J.has(l)||J.set(l,Et(l)),J.get(l)):{}}async function Ct(l){return(await Tt(l)).presets||[]}async function Pt(l,t){return X.has(l)||X.set(l,Dt(l,t)),X.get(l)}async function jt(l,t,e){let s=`${q}/substances/file:${l}/channels/basecolor?$outputsize=${tt},${tt}&format=png&image1=file:${t}`;s=Object.keys(e).reduce((i,d)=>`${i}&${d}=${e[d]}`,s);const n=await(await fetch(s)).blob();return await _t(n)}async function At(l,t,e,s={}){const o=await at(e),n=await Ct(e),a=await Pt(l,t);return s.preset||(s.preset=n.length>0?n[0].name:""),await jt(o,a,s)}const et=10,st=5;class E{static get defaultData(){return{}}static create(t,{documentModel:e}){return t.data=Object.assign(this.defaultData,t.data),e.createNode(t)}static update(t,e,{documentModel:s},o=!0,n=!1){return s.updateNode(t,e,o)}static delete(t,{documentModel:e}){return e.deleteNode(t)}static convertRawGestureToNodeRelativeTotalDeltaVector(t,e,s,o,n){const{editorModel:{_state:{renderScale:a}}}=n,i=o.nodes[e],{totalDeltaX:d,totalDeltaY:c}=s;let u=i,h=0;for(;u&&u.type!=="canvas";)h+=u.rotate,u=o.nodes[u.parentId];const y={x:d/a,y:c/a};return x.rotatePoint(y,-h)}static snaplinesOfNode({width:t,height:e,globalTransform:s}){const o=b.transformPoint(0,0,s),n=b.transformPoint(t,0,s),a=b.transformPoint(t,e,s),i=b.transformPoint(0,e,s);return[[o,n],[n,a],[a,i],[i,o]]}static centroidOfNode({x:t,y:e,width:s,height:o,rotate:n}){return x.rotatePoint({x:t+s/2,y:e+o/2},n,{x:t,y:e})}static adjustBounds(t,e,s,o,n,a,i){const d=n.nodes[e],{x:c,y:u,width:h,height:y,rotate:p}=d,r={},{editorModel:{_state:{renderScale:f}}}=i;switch(t){case"translate":r.x=c+s.x,r.y=u+s.y;break;case"rotate":const F={x:0,y:40+y/2},M={x:F.x+s.x,y:F.y-s.y},w=x.radiansBetweenPoints({x:0,y:0},F),K=x.radiansBetweenPoints({x:0,y:0},M),G=w-K,k=p+G,C={x:-h/2,y:y/2},_=x.rotatePoint(C,-G),$=x.vectorBetweenPoints(_,C),R=x.rotatePoint($,-p);r.x=c+R.x,r.y=u-R.y,r.rotate=k;break;case"ne":case"se":case"e":r.width=h+s.x,r.width&&r.width<0&&(r.x=c+r.width,r.width=-r.width);break;case"nw":case"sw":case"w":r.x=c+s.x,r.width=h-s.x,r.width&&r.width<0&&(r.x=c+h,r.width=-r.width);break}switch(t){case"nw":case"n":case"ne":r.y=u+s.y,r.height=y-s.y,r.height&&r.height<0&&(r.y=u+y,r.height=-r.height);break;case"sw":case"s":case"se":r.height=y+s.y,r.height&&r.height<0&&(r.y=u+r.height,r.height=-r.height);break}const m=typeof r.x=="number",g=typeof r.y=="number";if((m||g)&&t!=="rotate"){const F={x:(m?r.x:c)-c,y:(g?r.y:u)-u},M=x.rotatePoint(F,p);r.x=c+M.x,r.y=u+M.y}const S=typeof r.x=="number"?r.x:c,v=typeof r.y=="number"?r.y:u,N=typeof r.rotate=="number"?r.rotate:p,A=this.centroidOfNode(d),O=this.centroidOfNode({x:S,y:v,width:typeof r.width=="number"?r.width:h,height:typeof r.height=="number"?r.height:y,rotate:typeof r.rotate=="number"?r.rotate:p});let I=st+1,L=0;const D=[],V=[];if(t==="rotate"){const M=(x.degrees(N)%360+360)%90;i.documentModel.forEachNode(w=>{if(w.id===e||w.type==="artboard"||w.type==="canvas"||w.parentId!==d.parentId)return;const k=(x.degrees(w.rotate)%360+360)%90-M,C=Math.abs(k);if(C<I&&(D.splice(0,D.length),I=C,L=x.radians(k)),C===I){const _=this.centroidOfNode(w),$={x:_.x+50/f,y:_.y},R={x:_.x,y:_.y-50/f},dt=x.rotatePoint($,w.rotate,_),ct=x.rotatePoint(R,w.rotate,_);D.push(_),V.push([_,dt]),V.push([_,ct])}})}let H=et+1,U={x:0,y:0};if(t==="translate"&&i.documentModel.forEachNode(F=>{if(F.id===e||F.type==="artboard"||F.parentId!==d.parentId)return;const M=this.centroidOfNode(F),w=x.distance(O,M);w<H&&(H=w,U={x:M.x-O.x,y:M.y-O.y},D.splice(0,D.length),D.push(M))}),I<=st){D.push(A),r.rotate=N+L;const{x:F,y:M}=x.rotatePoint({x:S,y:v},L,A);r.x=F,r.y=M}H<=et&&(r.x=S+U.x,r.y=v+U.y),i.editorModel.setSnappoints(...D),i.editorModel.setSnaplines(...V),this.update(e,r,i)}}class Ot extends E{static get defaultData(){return{}}}class Bt extends E{static get defaultData(){return{name:"",color:"#FFFFFF",borderRadius:0,borderSize:0,borderColor:"#CCCCCC"}}static create(t,e){return t.data=t.data||{},t.width=324,t.height=200,super.create(t,e)}}class kt extends E{static get defaultData(){return{name:"",color:"#000000",fontLabel:"",font:"Futura",weight:"normal",style:"normal",size:40,letterSpacing:0,swappable:!1,alignment:"left",text:"default"}}static create(t,e){t.data=t.data||{},t.data=Object.assign(this.defaultData,t.data);const{size:s,text:o,font:n,weight:a,style:i}=t.data,d=o.split(`
`),u=Q(d,n,a,i).map(h=>h*s);return t.height=d.length*s,t.width=Math.max(...u),super.create(t,e)}static update(t,e,s,o=!0){const{data:n}=e;if(n&&(n.hasOwnProperty("text")||n.hasOwnProperty("font")||n.hasOwnProperty("weight")||n.hasOwnProperty("style")||n.hasOwnProperty("size"))){const a=s.documentModel._state.nodes[t],i=n.size||a.data.size,d=n.text||a.data.text,c=n.font||a.data.font,u=n.weight||a.data.weight,h=n.style||a.data.style,y=d.split(`
`),r=Q(y,c,u,h).map(f=>f*i);e.height=y.length*i,e.width=Math.max(...r)}return s.documentModel.updateNode(t,e,o)}}class z extends E{static convertRawGestureToNodeRelativeTotalDeltaVector(t,e,s,o,n){const a=o.nodes[e],{width:i,height:d}=a;let c=super.convertRawGestureToNodeRelativeTotalDeltaVector(t,e,s,o,n);const u={x:0,y:0};let h=c;switch(t){case"ne":h={x:i,y:-d};break;case"se":h={x:-i,y:-d};break;case"sw":h={x:-i,y:d};break;case"nw":h={x:i,y:d};break}return c=x.closestPointOfLineToAPoint(c,u,h),c}}function Rt(l){return!!(l.data&&(typeof l.data.substance!="undefined"||typeof l.data.substanceConfig!="undefined"))}function it(l,t,e){return`${t}:${JSON.stringify(e)}`}function nt(l,t,e){const{data:{src:s,originalSrc:o,substance:n,substanceConfig:a}}=e.documentModel.getNode(t);return l===it(o||s,n,a)}class zt extends z{static get defaultData(){return{name:"",src:"/files/default.jpg",substanceName:"",substanceConfig:{},originalSrc:"",aspectRatio:1,nativeWidth:1,nativeHeight:1,swappable:!1}}static create(t,e){return t.data=t.data||{},t.data=Object.assign(this.defaultData,t.data),super.create(t,e)}static update(t,e,s,o=!0,n){const a=e.data&&e.data.src;let i="";if(a&&(i=e.data.src,e.data.originalSrc=""),a||Rt(e)){const{substance:d,substanceConfig:c}=e.data,u=s.documentModel.getNode(t),h=u.data.substance,y=u.data.substanceConfig,p=typeof d!="undefined"?d:h,r=typeof c!="undefined"?c:y,f=i||u.data.originalSrc||u.data.src;if((a||!h&&p)&&(e.data.originalSrc=f),h&&!p&&(s.editorModel.removeLoading(t),e.data.src=f,e.data.originalSrc=""),p){s.editorModel.addLoading(t);const m=it(f,p,r);Promise.all([lt(p),wt(f)]).then(([g,S])=>At(f,S,g,r)).then(g=>{if(!nt(m,t,s))throw new Error("Invalid Substance key");return Ft(g)}).then(g=>ht(g)).then(g=>Nt(g.url).then(()=>g)).then(g=>{if(!nt(m,t,s))throw new Error("Invalid Substance key");super.update(t,{data:{src:g.url}},s,o,n),s.renderCallback(),s.editorModel.removeLoading(t)}).catch(()=>{console.info("SUBSTANCE APPLICATION FAILED"),s.renderCallback(),s.editorModel.removeLoading(t),super.update(t,{data:{substance:h,substanceConfig:y}},s,o,n),alert("SUBSTANCE APPLICATION FAILED")})}}return super.update(t,e,s,o,n)}}class Lt extends E{static get defaultData(){return{name:"",color:"#FFFFFF",borderSize:0,borderColor:"#CCCCCC"}}static create(t,e){return t.data=t.data||{},t.width=200,t.height=324,super.create(t,e)}}class Vt extends z{static get defaultData(){return{name:"",color:"#FFFFFF",borderSize:0,borderColor:"#CCCCCC"}}static create(t,e){return t.data=t.data||{},t.width=200,t.height=200,super.create(t,e)}}class Ht extends E{static get defaultData(){return{name:"artboard",color:"#FFFFFF"}}static create(t,e){console.info("CREATE"),t.data=t.data||{},t.parentId||(t.parentId=e.documentModel._state.rootNodeId);const s=e.documentModel.findAll(a=>a.type==="artboard"),o=s.length,n=`Artboard ${o+1}`;if(t.data.name=n,t.width=800,t.height=600,t.x=-t.width/2,t.y=-t.height/2,o>0){const a=e.documentModel.getNode(s[o-1]);t.x=a.x+a.width+100,t.y=a.y}return super.create(t,e)}}class Ut extends z{static get defaultData(){return{name:"Artboard Group"}}}class Gt extends z{static update(t,e,s,o=!0){let n=o;if(typeof e.width=="number"){n=!1;const{width:a,children:i}=s.documentModel._state.nodes[t],d=e.width/a,c=[d,0,0,d,0,0];i.forEach(u=>s.applyTransformMatrix(u,c,!0))}return s.documentModel.updateNode(t,e,n)}}class rt extends E{}class $t extends rt{static get defaultData(){return{}}}class Wt extends rt{static get defaultData(){return{color:"#CCCCCC",size:4,alignment:"outer",shape:"rectangle"}}}class Jt extends E{static get defaultData(){return{name:"Variant Set"}}}const Xt={canvas:Ot,artboard:Ht,"artboard-group":Ut,rectangle:Bt,text:kt,image:zt,ellipse:Lt,circle:Vt,container:Gt,"effect-graph":$t,"effect-stroke":Wt,"variant-set":Jt};function B(l){return Xt[l]}const Yt={duotone:{displayName:"Duotone",uiInputs:[{label:"Intensity",key:"size",type:"slider",min:1,max:100}],nodes:{in:{x:25,y:25,id:"in",type:"graph-input",input:{object:{type:"object"},size:{type:"number"}},output:{object:{type:"object"},size:{type:"number"}}},out:{x:25,y:25,id:"out",type:"graph-output",input:{object:{type:"object"}},output:{object:{type:"object"}}},"map-range":{x:25,y:25,id:"map-range",type:"map-range",input:{value:{type:"number"},inA:{type:"number",value:1},inB:{type:"number",value:100},outA:{type:"number",value:10},outB:{type:"number",value:90}},output:{value:{type:"number"}}},overlay:{x:25,y:25,id:"overlay",type:"overlay",input:{object:{type:"object"},color:{type:"string",value:"#27429B"},opacity:{type:"number"}},output:{object:{type:"object"}}}},adjacencyList:{"in:output:object":["overlay:input:object"],"in:output:size":["map-range:input:value"],"map-range:output:value":["overlay:input:opacity"],"overlay:output:object":["out:input:object"]}},shake:{displayName:"Shake",uiInputs:[{label:"Amplitude",key:"amplitude",type:"slider",min:0,max:1},{label:"Frequency",key:"frequency",type:"slider",min:0,max:1}],nodes:{in:{x:18,y:17,id:"in",type:"graph-input",input:{},output:{object:{type:"object"},amplitude:{type:"number"},frequency:{type:"number"}}},out:{x:1196,y:25,id:"out",type:"graph-output",input:{object:{type:"object"}},output:{object:{type:"object"}}},time:{x:372,y:241,id:"time",type:"time",input:{},output:{seconds:{type:"number"}}},"map-range":{x:782,y:100,id:"map-range",type:"map-range",input:{value:{type:"number"},inA:{type:"number",value:-1},inB:{type:"number",value:1},outA:{type:"number",value:1},outB:{type:"number",value:100}},output:{value:{type:"number"}}},"map-range-freq":{x:208,y:158,id:"map-range-freq",type:"map-range",input:{value:{type:"number"},inA:{type:"number",value:0},inB:{type:"number",value:1},outA:{type:"number",value:1},outB:{type:"number",value:.01}},output:{value:{type:"number"}}},oscillate:{x:571,y:144,id:"oscillate",type:"oscillate",input:{frequency:{type:"number"},amplitude:{type:"number"},x:{type:"number"}},output:{y:{type:"number"}}},translate:{x:987,y:12,id:"translate",type:"translate",input:{object:{type:"object"},x:{type:"number"},y:{type:"number",value:0}},output:{object:{type:"object"}}}},adjacencyList:{"in:output:object":["translate:input:object"],"in:output:frequency":["map-range-freq:input:value"],"map-range-freq:output:value":["oscillate:input:frequency"],"in:output:amplitude":["oscillate:input:amplitude"],"time:output:seconds":["oscillate:input:x"],"oscillate:output:y":["map-range:input:value"],"map-range:output:value":["translate:input:x"],"translate:output:object":["out:input:object"]}},"rainbow-border":{displayName:"Rainbow Border",uiInputs:[{label:"Size",key:"size",type:"slider",min:1,max:100}],nodes:{in:{x:13,y:11,id:"in",type:"graph-input",input:{},output:{object:{type:"object"},size:{type:"number"}}},out:{x:2825,y:21,id:"out",type:"graph-output",input:{object:{type:"object"}},output:{object:{type:"object"}}},time:{x:347,y:239,id:"time",type:"time",input:{},output:{seconds:{type:"number"}}},"half-rainbow-size":{x:347,y:89,id:"half-rainbow-size",type:"multiply",input:{A:{type:"number"},B:{type:"number",value:.5}},output:{value:{type:"number"}}},oscillate:{x:554,y:77,id:"oscillate",type:"oscillate",input:{frequency:{type:"number",value:.5},amplitude:{type:"number"},x:{type:"number"}},output:{y:{type:"number"}}},"add-oscillated-input":{x:738,y:137,id:"add-oscillated-input",type:"add",input:{A:{type:"number"},B:{type:"number"}},output:{value:{type:"number"}}},"map-range":{x:161,y:166,id:"map-range",type:"map-range",input:{value:{type:"number"},inA:{type:"number",value:1},inB:{type:"number",value:100},outA:{type:"number",value:14},outB:{type:"number",value:100}},output:{value:{type:"number"}}},multiply:{x:932,y:256,id:"multiply",type:"multiply",input:{A:{type:"number"},B:{type:"number",value:1/7}},output:{value:{type:"number"}}},subtract1:{x:1213,y:191,id:"subtract1",type:"subtract",input:{A:{type:"number"},B:{type:"number"}},output:{value:{type:"number"}}},subtract2:{x:1423,y:202,id:"subtract2",type:"subtract",input:{A:{type:"number"},B:{type:"number"}},output:{value:{type:"number"}}},subtract3:{x:1633,y:216,id:"subtract3",type:"subtract",input:{A:{type:"number"},B:{type:"number"}},output:{value:{type:"number"}}},subtract4:{x:1845,y:220,id:"subtract4",type:"subtract",input:{A:{type:"number"},B:{type:"number"}},output:{value:{type:"number"}}},subtract5:{x:2057,y:238,id:"subtract5",type:"subtract",input:{A:{type:"number"},B:{type:"number"}},output:{value:{type:"number"}}},subtract6:{x:2241,y:254,id:"subtract6",type:"subtract",input:{A:{type:"number"},B:{type:"number"}},output:{value:{type:"number"}}},red:{x:1194,y:13,id:"red",type:"stroke",input:{object:{type:"object"},color:{type:"string",value:"#ff0000"},size:{type:"number"},alignment:{type:"string",value:"outside"}},output:{object:{type:"object"}}},orange:{x:1429,y:17,id:"orange",type:"stroke",input:{object:{type:"object"},color:{type:"string",value:"#FF7F00"},size:{type:"number"},alignment:{type:"string",value:"outside"}},output:{object:{type:"object"}}},yellow:{x:1666,y:27,id:"yellow",type:"stroke",input:{object:{type:"object"},color:{type:"string",value:"#FFFF00"},size:{type:"number"},alignment:{type:"string",value:"outside"}},output:{object:{type:"object"}}},green:{x:1904,y:40,id:"green",type:"stroke",input:{object:{type:"object"},color:{type:"string",value:"#00ff00"},size:{type:"number"},alignment:{type:"string",value:"outside"}},output:{object:{type:"object"}}},blue:{x:2134,y:57,id:"blue",type:"stroke",input:{object:{type:"object"},color:{type:"string",value:"#0000ff"},size:{type:"number"},alignment:{type:"string",value:"outside"}},output:{object:{type:"object"}}},indigo:{x:2362,y:81,id:"indigo",type:"stroke",input:{object:{type:"object"},color:{type:"string",value:"#4b0082"},size:{type:"number"},alignment:{type:"string",value:"outside"}},output:{object:{type:"object"}}},violet:{x:2590,y:112,id:"violet",type:"stroke",input:{object:{type:"object"},color:{type:"string",value:"#9400d3"},size:{type:"number"},alignment:{type:"string",value:"outside"}},output:{object:{type:"object"}}}},adjacencyList:{"in:output:object":["red:input:object"],"in:output:size":["map-range:input:value"],"time:output:seconds":["oscillate:input:x"],"oscillate:output:y":["add-oscillated-input:input:A"],"half-rainbow-size:output:value":["oscillate:input:amplitude"],"multiply:output:value":["subtract1:input:B","subtract2:input:B","subtract3:input:B","subtract4:input:B","subtract5:input:B","subtract6:input:B"],"map-range:output:value":["add-oscillated-input:input:B","half-rainbow-size:input:A"],"add-oscillated-input:output:value":["red:input:size","multiply:input:A","subtract1:input:A"],"subtract1:output:value":["orange:input:size","subtract2:input:A"],"subtract2:output:value":["yellow:input:size","subtract3:input:A"],"subtract3:output:value":["green:input:size","subtract4:input:A"],"subtract4:output:value":["blue:input:size","subtract5:input:A"],"subtract5:output:value":["indigo:input:size","subtract6:input:A"],"subtract6:output:value":["violet:input:size"],"red:output:object":["orange:input:object"],"orange:output:object":["yellow:input:object"],"yellow:output:object":["green:input:object"],"green:output:object":["blue:input:object"],"blue:output:object":["indigo:input:object"],"indigo:output:object":["violet:input:object"],"violet:output:object":["out:input:object"]}}};function qt(l){return JSON.parse(JSON.stringify(Yt[l]))}function P(l,t){const e=t.nodes[l],{parentId:s,x:o,y:n,rotate:a}=e,i=b.compose(o,n,a);let d=t.nodes[s];for(;d;){const{parentId:c,x:u,y:h,rotate:y}=d,p=b.compose(u,h,y);b.multiply(i,p,i),d=t.nodes[c]}return i}class se{constructor(t,e,s=()=>{},o=()=>{}){this.isNodeUnderMutation=!1,this.renderCallback=s,this.selectionCallback=o,this.undoHistory=new pt,this.documentModel=t,this.displayGraphController=new ut,this.editorModel=e,this.validateInitialModelState(),this.registerNewUndoableDocumentState=ft(this._registerNewUndoableDocumentState.bind(this),150),this.handleNewDocumentState(),this.trackedGestures=new Map}validateInitialModelState(){this.documentModel.forEachNode(t=>{const s=B(t.type).defaultData;Object.assign(s,t.data),this.documentModel.updateNode(t.id,{data:s})})}handleNewDocumentState(){this.registerNewUndoableDocumentState(this.documentModel.stringify()),this.editorModel.setIsDirty(!0)}generateDisplayGraph(){return this.displayGraphController.generateDisplayGraphFromDocumentModel(this.documentModel,this.editorModel._state.timelinePosition)}semanticInferenceForScope(t){const e={};return this.documentModel.traverseSubtreeOfNode(t,s=>{s.type!=="artboard"&&s.data.name&&(typeof e[s.data.name]=="undefined"&&(e[s.data.name]=[]),e[s.data.name].push(s.id))}),e}handleNodeUnderMutation(){this.isNodeUnderMutation=!0,this.editorModel.setIsNodeUnderMutation(!0),this.mutationTimeout&&clearTimeout(this.mutationTimeout),this.mutationTimeout=setTimeout(()=>{this.editorModel.setIsNodeUnderMutation(!1),this.renderCallback()},400)}_registerNewUndoableDocumentState(t){this.undoHistory.save(t),this.editorModel.setCanRedo(this.undoHistory.canRedo),this.editorModel.setCanUndo(this.undoHistory.canUndo),this.renderCallback()}undo(){const t=this.undoHistory.undo();this.editorModel.setCanRedo(this.undoHistory.canRedo),this.editorModel.setCanUndo(this.undoHistory.canUndo),this.selectionCallback(),this.documentModel.setStringifiedState(t),this.renderCallback()}redo(){const t=this.undoHistory.redo();this.editorModel.setCanRedo(this.undoHistory.canRedo),this.editorModel.setCanUndo(this.undoHistory.canUndo),this.selectionCallback(),this.documentModel.setStringifiedState(t),this.renderCallback()}save(){this.documentModel.saveToStorageService().then(()=>{window.history.replaceState(null,"",`?id=${this.documentModel._state.id}`),this.editorModel.setIsSaved(!0),this.editorModel.setIsDirty(!1),this.renderCallback()}).then(()=>{const t=`https://git.corp.adobe.com/pages/CARGO/Prototype/reuse/?kit=${this.documentModel._state.id}`;window.open(t,"reuse","height=740,width=1200,menubar=no,titlebar=no")})}duplicate(){return this.documentModel.duplicateToStorageService().then(()=>{window.history.replaceState(null,"",`?id=${this.documentModel._state.id}`),this.editorModel.setIsSaved(!0),this.editorModel.setIsDirty(!1),this.renderCallback()})}handleBoundsAdjustStart(t,{gestureId:e}){if(this.editorModel._state.isPanningMode){this.editorModel.setIsPanning(!0),this.renderCallback();return}this.trackedGestures.set(e,{docStateAtStart:this.documentModel.state,displayGraphAtStart:this.displayGraphController.staticDisplayGraphState}),this.editorModel.addDragging(t)}getGlobalPlacementForNode(t){const e=P(t,this.documentModel._state),{position:{x:s,y:o},rotation:n}=b.decompose(e);return{x:s,y:o,rotation:n}}getGlobalBoundsPointsForNode(t){const{width:e,height:s}=this.documentModel._state.nodes[t],o=P(t,this.documentModel._state);return[b.transformPoint(0,0,o),b.transformPoint(e,0,o),b.transformPoint(e,s,o),b.transformPoint(0,s,o)]}conformChildrenArtboardIntersections(){const t=[],e=[],{rootNodeId:s,nodes:o}=this.documentModel._state,{children:n}=o[s],a=new Map;n.forEach(i=>{const d=this.documentModel.getNodeType(i);if(d==="artboard-group"){const c=o[i];e.push(...c.children)}else d==="artboard"?e.push(i):(t.push(i),a.set(i,this.getGlobalBoundsPointsForNode(i)))}),e.forEach(i=>{const d=o[i];a.set(i,this.getGlobalBoundsPointsForNode(i)),d.children.forEach(c=>{t.push(c),a.set(c,this.getGlobalBoundsPointsForNode(c))})}),t.forEach(i=>{const d=a.get(i),c=this.documentModel.getNodeParentId(i),u=a.get(c);if(u){if(x.doRectanglesIntersect(d,u))return;this.update(i,{parentId:this.documentModel._state.rootNodeId})}e.forEach(h=>{if(c===h)return;const y=a.get(h);x.doRectanglesIntersect(d,y)&&this.update(i,{parentId:h})})})}conformContainerBoundsToChildren(...t){console.info("conformContainerBoundsToChildren");const e=[];t.forEach(s=>{const o=this.documentModel._state.nodes[s],{parentId:n,type:a,children:i,x:d,y:c,rotate:u}=o;if(n&&e.indexOf(n)&&e.push(n),i.length===0||a==="canvas"||a==="artboard")return;const h=[];i.forEach(f=>{const m=this.documentModel._state.nodes[f];if(!m.variantSetId)return;const g=this.documentModel._state.nodes[m.variantSetId];for(let S=0;S<g.items.length;S++){const v=g.items[S];v!==f&&(console.info("include variant",v),h.push(v))}});const y=[...i,...h],p=this.unrotatedLocalBounds(...y),r=x.rotatePoint(p,u);this.documentModel.updateNode(s,{x:d+r.x,y:c+r.y,width:p.width,height:p.height}),y.forEach(f=>{const m=this.documentModel._state.nodes[f];this.documentModel.updateNode(f,{x:m.x-p.x,y:m.y-p.y})})}),e.length>0&&this.conformContainerBoundsToChildren(...e)}applyTransformMatrix(t,e,s=!1){const o={},n=this.documentModel._state.nodes[t],a=b.compose(n.x,n.y,n.rotate),i=b.multiply([],a,e),{scale:d,rotation:c}=b.decompose(i);o.x=n.x*d.x,o.y=n.y*d.y,o.rotate=c,o.width=n.width*d.x,o.height=n.height*d.y,n.type==="text"&&(o.data={size:n.data.size*d.x,letterSpacing:n.data.letterSpacing*d.x});const u=!1;this.update(t,o,s,u)}handleBoundsAdjust(t,e,s){const{gestureId:o,deltaX:n,deltaY:a}=e,i=this.trackedGestures.get(o);if(this.editorModel._state.isPanning){this.editorModel.setOriginOffsetX(this.editorModel._state.originOffsetX+n),this.editorModel.setOriginOffsetY(this.editorModel._state.originOffsetY+a),this.renderCallback();return}this.editorModel._state.selections.forEach(d=>{const c=this.documentModel.getNodeType(d);if(i){const{docStateAtStart:u,displayGraphAtStart:h}=i,y=B(c),p=y.convertRawGestureToNodeRelativeTotalDeltaVector(s,d,e,u,this);y.adjustBounds(s,d,p,e,u,h,this)}}),this.renderCallback()}applyEffectGraphEdges(t,e){const{data:{graph:s}}=this.documentModel._state.nodes[t],o={};e.edges.forEach(n=>{const a=`${n.outNodeId}:output:${n.outPortId}`,i=`${n.inNodeId}:input:${n.inPortId}`;o[a]||(o[a]=[]),o[a].push(i)}),s.adjacencyList=o,this.documentModel.updateNode(t,{data:{graph:s}})}applyEffectGraphArrangement(t,e){const{data:{graph:s}}=this.documentModel._state.nodes[t];Object.keys(e).forEach(o=>{const n=e[o],a=s.nodes[o];a.x=Math.round(n.x),a.y=Math.round(n.y)}),this.documentModel.updateNode(t,{data:{graph:s}})}handleBoundsAdjustEnd(t,{gestureId:e}){if(this.editorModel._state.isPanning===!0){this.editorModel.setIsPanning(!1),this.renderCallback();return}const s=[];this.editorModel._state.selections.forEach(o=>{const n=this.documentModel.getNodeParentId(o),a=this.documentModel.getNodeType(n);n&&a!=="canvas"&&s.indexOf(n)===-1&&s.push(n)}),this.conformContainerBoundsToChildren(...s),this.conformChildrenArtboardIntersections(),this.trackedGestures.delete(e),this.editorModel.removeDragging(t),this.editorModel.setSnaplines(),this.editorModel.setSnappoints(),this.handleNewDocumentState()}create(t,e=!1){const o=B(t.type).create(t,this);return this.conformChildrenArtboardIntersections(),e===!1&&this.handleNewDocumentState(),this.renderCallback(),o}update(t,e,s=!1,o=!0){const n=this.documentModel.getNodeType(t),a=this.documentModel.getNodeParentId(t),i=this.documentModel.getNodeType(a),d=B(n);let c="",u="",h=!0;if(e.parentId&&e.parentId!==a&&(c=e.parentId,u=this.documentModel.getNodeType(c),n==="artboard"&&u!=="artboard-group"&&u!=="canvas"&&(h=!1,delete e.parentId),n!=="artboard"&&u==="artboard-group"&&(h=!1,delete e.parentId),n==="artboard-group"&&u!=="canvas"&&(h=!1,delete e.parentId),h)){const y=P(t,this.documentModel._state),p=P(c,this.documentModel._state),r=b.difference([],p,y),f=b.decompose(r),{x:m,y:g,rotate:S}=e;m===void 0&&(e.x=f.position.x),g===void 0&&(e.y=f.position.y),S===void 0&&(e.rotate=f.rotation)}d.update(t,e,this,o),a&&i!=="canvas"&&s===!1&&this.conformContainerBoundsToChildren(a),c&&h&&u!=="canvas"&&s===!1&&this.conformContainerBoundsToChildren(c),s===!1&&this.handleNewDocumentState(),this.renderCallback()}delete(t,e=!1){const s=this.documentModel.getNodeType(t),o=this.documentModel.getNodeParentId(t);B(s).delete(t,this),this.conformContainerBoundsToChildren(o),this.conformChildrenArtboardIntersections(),e===!1&&this.handleNewDocumentState(),this.renderCallback()}createEffect(t,e){const s=qt(e),o={};s.uiInputs.forEach(n=>{o[n.key]=0}),o.graph=s,this.create({parentId:t,index:0,type:"effect-graph",isEffect:!0,data:o})}createShape(t){const{originOffsetX:e,originOffsetY:s,renderScale:o,viewportWidth:n,viewportHeight:a}=this.editorModel._state;this.create({parentId:this.documentModel._state.rootNodeId,type:t,x:(-e+n/2)/o,y:(-s+a/2)/o,data:{color:`#${Z.color}`,borderSize:1}})}createText(t){const{originOffsetX:e,originOffsetY:s,renderScale:o,viewportWidth:n,viewportHeight:a}=this.editorModel._state,{font:i,weight:d,style:c,fontLabel:u,text:h}=t;this.create({parentId:this.documentModel._state.rootNodeId,type:"text",width:200,height:100,x:(-e+n/2)/o,y:(-s+a/2)/o,data:{text:h,font:i,weight:d,style:c,fontLabel:u,color:`#${Z.color}`}})}createImage(t){const{originOffsetX:e,originOffsetY:s,renderScale:o,viewportWidth:n,viewportHeight:a}=this.editorModel._state,{src:i,width:d,height:c}=t;this.create({parentId:this.documentModel._state.rootNodeId,type:"image",width:d,height:c,x:(-e+n/2)/o-d/2,y:(-s+a/2)/o-c/2,data:{aspectRatio:d/c,nativeWidth:d,nativeHeight:c,src:i}})}swapImage(t,e){console.log("swap!"),console.log(e);const s=this.documentModel._state.nodes[t],{src:o,width:n,height:a,bounds:i}=e;let d=[];s.variantSetId?(console.log("variantSet"),d=this.documentModel._state.nodes[s.variantSetId].items):d=[s.id],d.forEach(c=>{console.log(c);const u=this.documentModel._state.nodes[c];console.log(u);const h=this.cover(i[c],{width:n,height:a});console.log(h);const y=u.x+u.width/2,p=u.y+u.height/2,r=n,f=u.width/r,m=n*f,g=a*f,S=y-m/2,v=p-g/2;console.log(m,g),this.update(c,{width:m,height:g,x:S,y:v,data:{aspectRatio:n/a,nativeWidth:n,nativeHeight:a,src:o}})})}cover(t,e){console.log(t),console.log(e);let s=t.width/t.height,o=e.width/e.height;console.log(`old r: ${s},${o}`);let n=Math.max(t.width/e.width,t.height/e.height),a=e.width*n,i=e.height*n;return console.log(`new w: ${a},h:${i}`),console.log(`old w: ${t.width},h:${t.height}`),{w:a,h:i}}replaceImage(t,e){const s=this.documentModel._state.nodes[t],{src:o,width:n,height:a}=e,i=s.x+s.width/2,d=s.y+s.height/2,c=s.data.nativeWidth||n,u=s.width/c,h=n*u,y=a*u,p=i-h/2,r=d-y/2;console.log(h,y),this.update(t,{width:h,height:y,x:p,y:r,data:{aspectRatio:n/a,nativeWidth:n,nativeHeight:a,src:o}})}unrotatedLocalBounds(...t){const e=[],s=[];t.forEach(d=>{const{x:c,y:u,width:h,height:y,rotate:p}=this.documentModel._state.nodes[d],r=b.compose(c,u,p),f=b.transformPoint(0,0,r),m=b.transformPoint(h,0,r),g=b.transformPoint(0,y,r),S=b.transformPoint(h,y,r);e.push(f.x,m.x,g.x,S.x),s.push(f.y,m.y,g.y,S.y)});const o=Math.min(...e),n=Math.max(...e),a=Math.min(...s),i=Math.max(...s);return{x:o,y:a,width:n-o,height:i-a}}duplicateIdFromDocumentState(t,e){const s=e.nodes[t];if(!s)return"";const{selections:o}=this.editorModel._state,n=o.map(f=>this.documentModel.getNodeParentId(f)),a=[...new Set(n)],i=a.length===1?a[0]:this.documentModel._state.rootNodeId,d=P(t,e),c=P(i,this.documentModel.state),u=b.difference([],c,d),h=b.decompose(u);s.x=h.position.x,s.y=h.position.y,s.rotate=h.rotation,s.parentId=i;const y=this.documentModel.createNode({parentId:s.parentId,type:s.type,isEffect:s.isEffect,isEffectNode:s.isEffectNode,data:s.data,blendMode:s.blendMode,x:s.x,y:s.y,width:s.width,height:s.height,rotate:s.rotate}),p=[...s.children],r={};for(r[t]=y;p.length;){const f=p.shift(),m=e.nodes[f],g=this.documentModel.createNode({parentId:r[m.parentId],type:m.type,isEffect:m.isEffect,isEffectNode:m.isEffectNode,data:m.data,blendMode:m.blendMode,x:m.x,y:m.y,width:m.width,height:m.height,rotate:m.rotate});r[f]=g,p.push(...m.children)}return y}duplicateIdsFromDocumentState(t,e){const s=t.map(a=>this.duplicateIdFromDocumentState(a,e)),o=s.map(a=>this.documentModel.getNodeParentId(a)),n=[...new Set(o)];return this.conformContainerBoundsToChildren(...n),s}ungroupSelections(){const{selections:t}=this.editorModel._state;t.length!==0&&([...t].forEach(e=>{const{type:s,parentId:o,children:n,x:a,y:i,rotate:d}=this.documentModel.getNode(e);if(s!=="container")return;const c=this.indexWithinParent(e),u=b.compose(a,i,d);n.reverse().forEach(h=>{const y=this.documentModel.getNode(h),p=b.compose(y.x,y.y,y.rotate),r=b.multiply([],u,p),f=b.decompose(r);if(this.documentModel.updateNode(h,{parentId:o,index:c,x:f.position.x,y:f.position.y,rotate:f.rotation}),y.variantSetId){const m=this.documentModel.getNode(y.variantSetId),{items:g}=m;for(let S=0;S<g.length;S++){const v=g[S];if(v===h)continue;const N=this.documentModel.getNode(g[S]),A=b.compose(N.x,N.y,N.rotate),O=b.multiply([],u,A),I=b.decompose(O);this.documentModel.updateNode(v,{x:I.position.x,y:I.position.y,rotate:I.rotation})}}}),this.editorModel.removeAllStateForId(e),this.documentModel.deleteNode(e)}),this.handleNewDocumentState(),this.renderCallback())}groupSelections(){const{selections:t}=this.editorModel._state;if(t.length===0)return;let e=!1,s=!1,o=!1;const n=[];if(t.forEach(p=>{const r=this.documentModel.getNode(p),{type:f,parentId:m,variantSetId:g}=r;if(m!==this.documentModel._state.rootNodeId&&(o=!0),f==="artboard"?e=!0:(s=!0,this.documentModel.traverseSubtreeOfNode(p,S=>{S.type==="artboard"&&(s=!0)})),g){const S=this.documentModel.getNode(g),{items:v}=S;for(let N=0;N<v.length;N++)v[N]!==p&&n.push(v[N])}}),e&&s){alert("artboards cannot be grouped with non-artboards");return}if(e&&o){alert("artboards must be at root to be grouped");return}const i=t[0],d=this.documentModel._state.nodes[i].parentId,c=this.unrotatedLocalBounds(...t,...n),u=e?"artboard-group":"container",h=this.create({parentId:d,type:u,x:c.x,y:c.y,width:c.width,height:c.height});t.sort((p,r)=>{const f=this.indexWithinParent(p),m=this.indexWithinParent(r);return f===m?0:f>m?1:-1}).forEach(p=>{const{x:r,y:f}=this.documentModel._state.nodes[p];this.documentModel.updateNode(p,{parentId:h,x:r-c.x,y:f-c.y})}),n.forEach(p=>{const{x:r,y:f}=this.documentModel._state.nodes[p];this.documentModel.updateNode(p,{x:r-c.x,y:f-c.y})}),this.conformChildrenArtboardIntersections(),u!=="artboard-group"&&this.selectionCallback(h),this.handleNewDocumentState(),this.renderCallback()}addVariant(t){let s=this.documentModel._state.nodes[t].variantSetId;s||(s=this.create({type:"variant-set"}),this.documentModel.addNodeIdToVariantSet(s,t));const o=this.documentModel.duplicateNode(t);this.selectionCallback(o),this.documentModel.addNodeIdToVariantSet(s,o),this.documentModel.updateNode(t,{parentId:""}),this.handleNewDocumentState(),this.renderCallback()}deleteVariant(t,e){const o=this.documentModel._state.nodes[t].variantSetId,n=e.id;this.editorModel.removeAllStateForId(n);const a=this.documentModel.deleteVariant(o,n);a&&this.editorModel.addSelection(a),this.handleNewDocumentState(),this.renderCallback()}selectVariant(t,e){this.editorModel.removeAllStateForId(t),this.documentModel.swapActiveVariant(t,e),e&&this.editorModel.addSelection(e),this.handleNewDocumentState(),this.renderCallback()}makeVariantSetFromSelections(){let t="";const{selections:e}=this.editorModel._state,s=e[0];for(let n=0;n<e.length;n+=1){const a=e[n],{variantSetId:i}=this.documentModel._state.nodes[a];if(i){t=i;break}}t||(t=this.create({type:"variant-set"})),[...e].forEach(n=>{const{variantSetId:a}=this.documentModel._state.nodes[n];if(t!==a)if(a){const{items:i}=this.documentModel._state.nodes[a];[...i].forEach(d=>{this.documentModel.removeItemFromVariantSet(a,d),this.documentModel.addNodeIdToVariantSet(t,d)})}else this.documentModel.addNodeIdToVariantSet(t,n)});const{items:o}=this.documentModel._state.nodes[t];o.forEach(n=>{n!==s&&this.documentModel.updateNode(n,{parentId:""})}),this.selectionCallback(s),this.handleNewDocumentState(),this.renderCallback()}indexWithinParent(t){const e=this.documentModel._state.nodes[t];return this.documentModel._state.nodes[e.parentId].children.indexOf(t)}adjustLayerOrder(t,e){const s=this.indexWithinParent(t);this.documentModel.updateNode(t,{index:s+e}),this.handleNewDocumentState(),this.renderCallback()}delegateEvent(t){console.log("EVENTS?");const e=t.action||"none",s={};switch(e){case"undo":this.undo();break;case"redo":this.redo();break;case"save":this.save();break;case"duplicate":this.duplicate();break;case"conform-artboard-intersections":this.conformChildrenArtboardIntersections();break;case"group-selections":this.groupSelections();break;case"ungroup-selections":this.ungroupSelections();break;case"select-variant":if(console.log("Select Variant triggered"),!t.id||!t.value)return;this.selectVariant(t.id,t.value);break;case"replace-image":if(!t.id||!t.data)return;this.replaceImage(t.id,t.data);break;case"swap-image":if(!t.id||!t.data)return;console.log(t.data),this.swapImage(t.id,t.data);break;case"add-variant":if(!t.id)return;this.addVariant(t.id);break;case"delete-variant":if(!t.id||!t.data)return;this.deleteVariant(t.id,t.data);break;case"make-variant-set-from-selections":this.makeVariantSetFromSelections();break;case"set-thumbnail":this.documentModel.setThumbnail(t.data),this.handleNewDocumentState();break;case"set-extra-thumbnails":this.documentModel.setExtraThumbnails(...t.data),this.handleNewDocumentState();break;case"set-tags":this.documentModel.setTags(...t.data),this.handleNewDocumentState();break;case"set-author":this.documentModel.setAuthor(t.data),this.handleNewDocumentState();break;case"set-tool":this.documentModel.setTool(t.data),this.handleNewDocumentState();break;case"set-name":this.documentModel.setName(t.data),this.handleNewDocumentState();break;case"set-color":if(!t.id)return;this.handleNodeUnderMutation(),this.update(t.id,{data:{color:t.color}});break;case"set-text":if(!t.id)return;this.handleNodeUnderMutation(),this.update(t.id,{data:{text:t.value}});break;case"update-node":if(!t.id)return;this.handleNodeUnderMutation(),this.update(t.id,t.nodeData);break;case"set-size":if(!t.id)return;this.handleNodeUnderMutation(),this.update(t.id,{data:{size:t.value}});break;case"adjust-layer-order":if(!t.id||typeof t.value=="undefined")return;this.handleNodeUnderMutation(),this.adjustLayerOrder(t.id,t.value);break;case"set-properties":if(!t.id||typeof t.data=="undefined")return;this.handleNodeUnderMutation(),s.data=t.data,this.update(t.id,s);break;case"set-property":if(!t.id||typeof t.key=="undefined"||typeof t.value=="undefined")return;this.handleNodeUnderMutation(),s.data={},s.data[t.key]=t.value,this.update(t.id,s);break;case"add-artboard":this.create({type:"artboard",index:0});break;case"add-shape":if(!t.value)return;this.createShape(t.value);break;case"add-text":if(!t.data)return;this.createText(t.data);break;case"add-image":if(!t.data)return;this.createImage(t.data);break;case"add-effect":if(!t.effectId||(!t.id&&this.editorModel.selectionCount>0&&(t.id=this.editorModel._state.selections[0]),!t.id))return;this.createEffect(t.id,t.effectId);break;case"bounds-adjust-start":if(!t.data||!t.id)return;if(t.originalEvent&&t.originalEvent.detail.altKey===!0&&t.subject==="translate"){const o=this.duplicateIdsFromDocumentState(this.editorModel._state.selections,this.documentModel.state);this.selectionCallback(...o)}this.handleBoundsAdjustStart(t.id,t.data);break;case"bounds-adjust-end":if(!t.data||!t.id)return;this.handleBoundsAdjustEnd(t.id,t.data);break;case"bounds-adjust":if(!t.data||!t.id||!t.subject)return;this.handleBoundsAdjust(t.id,t.data,t.subject);break;case"load-file-state-from-json":if(!t.data)return;if(!t.data.id||!t.data.versionTag||!t.data.nodes||!t.data.rootNodeId){console.info("Invalid document json loaded",t.data);return}this.documentModel.setStringifiedState(JSON.stringify(t.data)),this.validateInitialModelState(),this.handleNewDocumentState(),this.renderCallback();break}}}class Y{static makeNodeObject({type:t="container",isEffect:e=!1,isEffectNode:s=!1,variantSetId:o="",substance:n={},blendMode:a="normal",parentId:i="",width:d=0,height:c=0,x:u=0,y:h=0,rotate:y=0,data:p={}}){return{id:j(),data:p,type:t,isEffect:e,isEffectNode:s,variantSetId:o,substance:n,blendMode:a,parentId:i,width:d,height:c,x:u,y:h,rotate:y,children:[],effects:[],items:[]}}static createNewDocumentState(){const t=this.makeNodeObject({type:"canvas"}),e=this.makeNodeObject({parentId:t.id,type:"artboard",width:600,height:600,x:-300,y:-300,data:{name:"Artboard 1"}});t.children.push(e.id);const s={id:`kit_x_${j()}`,author:"",tool:"",name:"",thumbnail:"",extraThumbnails:[],tags:[],versionTag:j(),rootNodeId:t.id,nodes:{},timelineDuration:5};return s.nodes[t.id]=t,s.nodes[e.id]=e,s}constructor(t){this.cargoKitIndexModel=t,this._state=Y.createNewDocumentState(),typeof this._state.author=="undefined"&&(this._state.author=""),typeof this._state.tool=="undefined"&&(this._state.tool=""),typeof this._state.name=="undefined"&&(this._state.name=""),typeof this._state.thumbnail=="undefined"&&(this._state.thumbnail=""),typeof this._state.extraThumbnails=="undefined"&&(this._state.extraThumbnails=[]),typeof this._state.tags=="undefined"&&(this._state.tags=[]),this.stringifiedState=""}async hydrateFromStorageService(t){const e=await this.cargoKitIndexModel.read(t);return typeof e.id=="string"&&(e.id=t,this._state=e,typeof this._state.author=="undefined"&&(this._state.author=""),typeof this._state.tool=="undefined"&&(this._state.tool=""),typeof this._state.name=="undefined"&&(this._state.name=""),typeof this._state.thumbnail=="undefined"&&(this._state.thumbnail=""),typeof this._state.extraThumbnails=="undefined"&&(this._state.extraThumbnails=[]),typeof this._state.tags=="undefined"&&(this._state.tags=[]),this.coerceValidNodeTree(),this.dirtyState()),this.state}coerceValidNodeTree(){const t=this._state.rootNodeId;if(!t)return;const e=this._state.nodes,s=e[t];if(!s){console.warn("NO ROOT NODE");return}for(const[o,n]of Object.entries(this._state.nodes))if(n.type==="variant-set"){const a=[];let i=!1;if([...n.items].forEach((d,c)=>{const u=e[d];u?(a.push(d),u.parentId&&(i=!0)):console.warn("BAD JSON STRUCTURE: MISSING VARIANT ITEM, DROPPING FROM SET")}),n.items=a,!i&&n.items.length>0){const d=n.items[0],c=e[d];c.parentId=t,s.children.push(d)}}for(const[o,n]of Object.entries(this._state.nodes)){if(n.type==="canvas")continue;if(n.type==="variant-set"){const i=[];[...n.items].forEach((d,c)=>{e[d]?i.push(d):console.warn("BAD JSON STRUCTURE: MISSING VARIANT ITEM, DROPPING FROM SET")}),n.items=i;continue}if(!n.parentId&&n.variantSetId)continue;n.parentId||(n.parentId=t,console.warn("BAD JSON STRUCTURE: MISSING PARENT ID, ADDING TO ROOT"));const a=e[n.parentId];a.children.indexOf(o)===-1&&(console.warn("BAD JSON STRUCTURE: MISSING CHILD REFERENCE, ADDING TO CHILDREN"),a.children.push(o))}}async saveToStorageService(){const t=this.state,e=t.id;await this.cargoKitIndexModel.update(e,t)}async duplicateToStorageService(){this._state.id=`kit_x_${j()}`,this.dirtyState(),await this.saveToStorageService()}setAuthor(t){this._state.author=t,this.dirtyState()}setTool(t){this._state.tool=t,this.dirtyState()}setName(t){this._state.name=t,this.dirtyState()}setThumbnail(t){this._state.thumbnail=t,this.dirtyState()}setTags(...t){this._state.tags=t,this.dirtyState()}setExtraThumbnails(...t){this._state.extraThumbnails=t,this.dirtyState()}setStringifiedState(t){!t||(this._state=JSON.parse(t),typeof this._state.author=="undefined"&&(this._state.author=""),typeof this._state.name=="undefined"&&(this._state.name=""),typeof this._state.thumbnail=="undefined"&&(this._state.thumbnail=""),typeof this._state.tags=="undefined"&&(this._state.tags=[]),this.dirtyState())}forEachNode(t){Object.values(this._state.nodes).forEach(t)}findAll(t){const e=[];return this.forEachNode(s=>{t(s)&&e.push(s.id)}),e}dirtyState(){this.stringifiedState=""}createNode({parentId:t,type:e,isEffect:s,isEffectNode:o,data:n,blendMode:a,x:i,y:d,width:c,height:u,index:h,rotate:y}){const p=Y.makeNodeObject({parentId:t,type:e,isEffect:s,isEffectNode:o,data:n,blendMode:a,x:i,y:d,width:c,height:u,rotate:y});if(this._state.nodes[p.id]=p,t){const r=this._state.nodes[t],f=p.isEffect?"effects":"children";typeof h=="number"?r[f].splice(h,0,p.id):r[f].push(p.id)}return this.dirtyState(),p.id}addNodeIdToVariantSet(t,e){this._state.nodes[t].items.push(e),this.updateNode(e,{variantSetId:t}),this.dirtyState()}swapActiveVariant(t,e){const o=this._state.nodes[t].parentId,a=this._state.nodes[o].children.indexOf(t);this.updateNode(t,{parentId:""}),this.updateNode(e,{parentId:o,index:a})}removeItemFromVariantSet(t,e){const s=this._state.nodes[t],o=this._state.nodes[e];if(!s||!o)return;const n=s.items.indexOf(e);if(n!==-1){if(s.items.splice(n,1),o.parentId||this.updateNode(e,{parentId:this._state.rootNodeId}),s.items.length===1){const a=this._state.nodes[s.items[0]];this.updateNode(a.id,{variantSetId:""}),this.deleteNode(t)}this.dirtyState()}}deleteVariant(t,e){const s=this._state.nodes[t],o=this._state.nodes[e],n=s.items.indexOf(e);let a="";if(o.parentId){const i=n===s.items.length-1?0:n+1;a=s.items[i],this.swapActiveVariant(e,a)}if(n>-1&&s.items.splice(n,1),s.items.length===1){const i=this._state.nodes[s.items[0]];this.updateNode(i.id,{variantSetId:""}),this.deleteNode(t)}return this.deleteNode(e),this.dirtyState(),a}updateNode(t,{parentId:e,index:s,x:o,y:n,rotate:a,width:i,height:d,variantSetId:c,substance:u,blendMode:h,data:y},p=!0){const r=this._state.nodes[t],f=r.isEffect?"effects":"children";if((e||e==="")&&e!==r.parentId){const m=this._state.nodes[r.parentId];if(m){const S=m[f].indexOf(t);S>-1&&m[f].splice(S,1)}const g=this._state.nodes[e];if(g){const S=g[f].length;g[f].splice(S,0,t)}r.parentId=e}if(typeof s=="number"){const m=this._state.nodes[r.parentId],g=m[f].indexOf(r.id);m[f].splice(g,1),m[f].splice(Math.max(0,s),0,r.id)}return y&&Object.assign(r.data,y),c!==void 0&&(r.variantSetId=c),h!==void 0&&(r.blendMode=h),u!==void 0&&(r.substance=u),a!==void 0&&(r.rotate=Math.round(a*1e4)/1e4),o!==void 0&&(r.x=r.rotate===0&&p?Math.ceil(o):o),n!==void 0&&(r.y=r.rotate===0&&p?Math.ceil(n):n),i!==void 0&&(r.width=p?Math.floor(i):i),d!==void 0&&(r.height=p?Math.floor(d):d),this.dirtyState(),this}deleteNode(t){const e=this._state.nodes[t],s=this._state.nodes[e.parentId],{children:o}=e;if([...o].forEach(this.deleteNode.bind(this)),s){const n=e.isEffect?"effects":"children",a=s[n].indexOf(t);a>-1&&s[n].splice(a,1)}return delete this._state.nodes[t],this.dirtyState(),this}duplicateNode(t){const e=this.getNode(t),s=this._state.nodes[e.parentId];let o=s.children.length,n="children";return s&&(n=e.isEffect?"effects":"children",o=s[n].indexOf(t)+1),this.createNode({parentId:e.parentId,type:e.type,isEffect:e.isEffect,isEffectNode:e.isEffectNode,data:e.data,blendMode:e.blendMode,x:e.x,y:e.y,width:e.width,height:e.height,index:o,rotate:e.rotate})}getNode(t){const e=this._state.nodes[t];return e?JSON.parse(JSON.stringify(e)):null}traverseSubtreeOfNode(t,e){const o=[...this._state.nodes[t].children];for(;o.length;){const n=o.shift(),a=this._state.nodes[n];e(a),o.push(...a.children)}}getNodeType(t){const e=this._state.nodes[t];return e?e.type:""}getNodesOfType(t){return Object.values(this._state.nodes).filter(e=>e.type===t)}getNodeParentId(t){const e=this._state.nodes[t];return e?e.parentId:""}getChildCount(t){const e=this._state.nodes[t];return e?e.children.length:0}stringify(){return this.stringifiedState||(this._state.versionTag=j(),this.stringifiedState=JSON.stringify(this._state)),this.stringifiedState}get rootNodeId(){return this._state.rootNodeId}get state(){return JSON.parse(this.stringify())}}class ne{constructor(){this._state={debug:!1,renderScale:1,isPanningMode:!1,isPanning:!1,isSaved:!1,isDirty:!1,isNodeUnderMutation:!1,canUndo:!1,canRedo:!1,originOffsetX:0,originOffsetY:0,viewportWidth:500,viewportHeight:500,targetLayersPanelHeight:300,showAssetsPanel:!1,activeToolbarSection:"discover",selections:[],loading:[],interactable:[],selectableHovers:[],hovers:[],dragging:[],resizing:[],snaplines:[],snappoints:[],messages:[],timelinePosition:0,isLayersPaletteOpen:!1},this._stringifiedState=""}_removeFromList(t,e){const s=t.indexOf(e);return s>-1&&t.splice(s,1),this.dirtyState(),this}_addToList(t,e){return t.indexOf(e)===-1&&(t.push(e),this.dirtyState()),this}dirtyState(){this._stringifiedState=""}clearSelections(){this._state.selections=[],this.dirtyState()}clearHovers(){this._state.hovers=[],this.dirtyState()}clearDragging(){this._state.dragging=[],this.dirtyState()}clearResizing(){this._state.resizing=[],this.dirtyState()}clearInteractable(){this._state.interactable=[],this.dirtyState()}isSelected(t){return this._state.selections.indexOf(t)>=0}isLoading(t){return this._state.loading.indexOf(t)>=0}isHovered(t){return this._state.hovers.indexOf(t)>=0}isDragging(t){return this._state.dragging.indexOf(t)>=0}isResizing(t){return this._state.resizing.indexOf(t)>=0}isNotSelected(t){return!this.isSelected(t)}isNotHovered(t){return!this.isHovered(t)}isNotDragging(t){return!this.isDragging(t)}isNotResizing(t){return!this.isResizing(t)}setActiveToolbarSection(t){return this._state.activeToolbarSection=t,this.dirtyState(),this}setDebug(t){return this._state.debug=t,this.dirtyState(),this}setTargetLayersPanelHeight(t){return this._state.targetLayersPanelHeight=t,this.dirtyState(),this}setShowAssetsPanel(t){return this._state.showAssetsPanel=t,this.dirtyState(),this}setCanUndo(t){return this._state.canUndo=t,this.dirtyState(),this}setCanRedo(t){return this._state.canRedo=t,this.dirtyState(),this}setRenderScale(t){return this._state.renderScale=t,this.dirtyState(),this}setIsPanningMode(t){return this._state.isPanningMode=t,this.dirtyState(),this}setIsPanning(t){return this._state.isPanning=t,this.dirtyState(),this}setIsSaved(t){return this._state.isSaved=t,this.dirtyState(),this}setIsDirty(t){return this._state.isDirty=t,this.dirtyState(),this}setIsLayersPaletteOpen(t){return this._state.isLayersPaletteOpen=t,this.dirtyState(),this}setIsNodeUnderMutation(t){return this._state.isNodeUnderMutation=t,this.dirtyState(),this}setOriginOffsetX(t){return this._state.originOffsetX=t,this.dirtyState(),this}setOriginOffsetY(t){return this._state.originOffsetY=t,this.dirtyState(),this}setViewportWidth(t){return this._state.viewportWidth=t,this.dirtyState(),this}setViewportHeight(t){return this._state.viewportHeight=t,this.dirtyState(),this}setHover(...t){return this._state.hovers=t,this.dirtyState(),this}setSelection(...t){return this._state.selections=t,this.dirtyState(),this}setLoading(...t){return this._state.loading=t,this.dirtyState(),this}setDragging(...t){return this._state.dragging=t,this.dirtyState(),this}setResizing(...t){return this._state.resizing=t,this.dirtyState(),this}setInteractable(...t){return this._state.interactable=t,this.dirtyState(),this}setSelectableHovers(...t){return this._state.selectableHovers=t,this.dirtyState(),this}setSnaplines(...t){return this._state.snaplines=t,this.dirtyState(),this}setSnappoints(...t){return this._state.snappoints=t,this.dirtyState(),this}setTimelinePosition(t){return this._state.timelinePosition=t,this.dirtyState(),this}addHover(t){return this._addToList(this._state.hovers,t)}addLoading(t){return console.log(t),this._addToList(this._state.loading,t)}addInteractable(t){return this._addToList(this._state.interactable,t)}addSelectableHovers(t){return this._addToList(this._state.selectableHovers,t)}addSelection(t){return this._addToList(this._state.selections,t)}addDragging(t){return this._addToList(this._state.dragging,t)}addResizing(t){return this._addToList(this._state.resizing,t)}addMessage(t){const e=j();return t.id=e,this._state.messages.push(t),this.dirtyState(),e}removeMessage(t){let e=-1;this._state.messages.forEach((s,o)=>{s.id===t&&(e=o)}),e>=0&&(this._state.messages.splice(e,1),this.dirtyState())}removeHover(t){return this._removeFromList(this._state.hovers,t)}removeLoading(t){return this._removeFromList(this._state.loading,t)}removeInteractable(t){return this._removeFromList(this._state.interactable,t)}removeselectableHovers(t){return this._removeFromList(this._state.selectableHovers,t)}removeSelection(t){return this._removeFromList(this._state.selections,t)}removeDragging(t){return this._removeFromList(this._state.dragging,t)}removeResizing(t){return this._removeFromList(this._state.resizing,t)}removeAllStateForId(t){this.removeResizing(t),this.removeDragging(t),this.removeLoading(t),this.removeSelection(t),this.removeHover(t),this.removeInteractable(t),this.removeselectableHovers(t)}get hoverCount(){return this._state.hovers.length}get selectionCount(){return this._state.selections.length}get loadingCount(){return this._state.selections.length}get draggingCount(){return this._state.dragging.length}get resizingCount(){return this._state.resizing.length}get interactableCount(){return this._state.resizing.length}get stringifiedState(){return this._stringifiedState||(this._stringifiedState=JSON.stringify(this._state)),this._stringifiedState}get state(){return JSON.parse(this.stringifiedState)}}export{Y as D,ne as E,ft as a,Ct as b,se as c,ee as d,Ft as e,Tt as g,te as r};
