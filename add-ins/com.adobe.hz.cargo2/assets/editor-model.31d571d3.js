import{t as Mt,r as $,g as Ot,d as zt,u as pt,a as Yt}from"./cargo-document-index.5bedc9f1.js";import{C as st,B as Ht,T as Gt,S as Wt,a as P,b as qt,s as B,G as Q,L as ft,c as yt,A as Xt}from"./pixi.a553ad36.js";function na(o){let t=!1;function e(){t=!1,o()}return function(){t||(t=!0,window.requestAnimationFrame(e))}}function ia(o,t=100){let e=null;return function(...s){e===null&&(e=setTimeout(function(){o.apply(this,s),e=null},t))}}class _{static get defaultMatrix(){return[1,0,0,1,0,0]}static getScalingTransform(t,e){return[t,0,0,e,0,0]}static getTranslationTransform(t,e){return[1,0,0,1,t,e]}static scale(t,e,s){const a=e[0],n=e[1],i=e[2],r=e[3],d=e[4],c=e[5],l=s[0],p=s[1];return t[0]=a*l,t[1]=n*l,t[2]=i*p,t[3]=r*p,t[4]=d,t[5]=c,t}static difference(t,e,s){return _.multiply(t,_.invert(t,e),s)}static multiply(t,e,...s){let a=e;for(let n=0;n<s.length;n+=1){const i=s[n],r=a[0],d=a[1],c=a[2],l=a[3],p=a[4],y=a[5],u=i[0],f=i[1],h=i[2],m=i[3],g=i[4],b=i[5];t[0]=r*u+c*f,t[1]=d*u+l*f,t[2]=r*h+c*m,t[3]=d*h+l*m,t[4]=r*g+c*b+p,t[5]=d*g+l*b+y,a=t}return t}static rotate(t,e,s){const a=e[0],n=e[1],i=e[2],r=e[3],d=e[4],c=e[5],l=Math.sin(s),p=Math.cos(s);return t[0]=a*p+i*l,t[1]=n*p+r*l,t[2]=a*-l+i*p,t[3]=n*-l+r*p,t[4]=d,t[5]=c,t}static translate(t,e,s){const a=e[0],n=e[1],i=e[2],r=e[3],d=e[4],c=e[5],l=s[0],p=s[1];return t[0]=a,t[1]=n,t[2]=i,t[3]=r,t[4]=a*l+i*p+d,t[5]=n*l+r*p+c,t}static transformPoint(t,e,s){return{x:t*s[0]+e*s[2]+s[4],y:t*s[1]+e*s[3]+s[5]}}static invert(t,e){const s=e[0],a=e[1],n=e[2],i=e[3],r=e[4],d=e[5];let c=s*i-a*n;return c?(c=1/c,t[0]=i*c,t[1]=-a*c,t[2]=-n*c,t[3]=s*c,t[4]=(n*d-i*r)*c,t[5]=(a*r-s*d)*c,t):(t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t)}static compose(t=0,e=0,s=0){const a=this.defaultMatrix;return this.translate(a,a,[t,e]),this.rotate(a,a,s),a}static decompose(t){const e=t[0],s=t[1],a=t[2],n=t[3],i=t[4],r=t[5],d=-Math.atan2(-a,n),c=Math.atan2(s,e),l=Math.abs(d+c),p=l<1e-5||Math.abs(Math.PI*2-l)<1e-5;return{skew:{x:p?0:d,y:p?0:c},scale:{x:Math.sqrt(e*e+s*s),y:Math.sqrt(a*a+n*n)},position:{x:i,y:r},rotation:p?c:0}}static decomposeScale(t){const e=t[0],s=t[1],a=t[2],n=t[3];return{x:Math.sqrt(e*e+s*s),y:Math.sqrt(a*a+n*n)}}}class x{static radians(t){return t*Math.PI/180}static degrees(t){return t*180/Math.PI}static slope(t,e){return(e.y-t.y)/(e.x-t.x)}static degreesBetweenPoints(t,e){return Math.atan2(e.y-t.y,e.x-t.x)*180/Math.PI}static radiansBetweenPoints(t,e){return this.radians(this.degreesBetweenPoints(t,e))}static vectorBetweenPoints(t,e){return{x:t.x-e.x,y:t.y-e.y}}static rotatePoint(t,e,s={x:0,y:0}){const a=Math.cos(e)*(t.x-s.x)-Math.sin(e)*(t.y-s.y)+s.x,n=Math.sin(e)*(t.x-s.x)+Math.cos(e)*(t.y-s.y)+s.y;return{x:a,y:n}}static screenCoordinateToDocumentCoordinate(t,e,s,a,n){const i={x:-a/s,y:-n/s},r={x:t/s,y:e/s};return{x:i.x+r.x,y:i.y+r.y}}static distance(t,e){const s=t.x-e.x,a=t.y-e.y;return Math.sqrt(s*s+a*a)}static distanceSquared(t,e){return(t.x-e.x)**2+(t.y-e.y)**2}static closestPointOfLineToAPoint(t,e,s){const a=((t.x-e.x)*(s.x-e.x)+(t.y-e.y)*(s.y-e.y))/x.distanceSquared(e,s);return{x:e.x+a*(s.x-e.x),y:e.y+a*(s.y-e.y)}}static isPointWithinRectangle({x:t,y:e},s,a){return t>s.x&&t<a.x&&e>s.y&&e<a.y}static doRectanglesIntersect(t,e){const s=[t,e];let a,n,i,r,d,c,l,p,y,u,f,h,m;for(l=0;l<s.length;l+=1)for(a=s[l],p=0;p<a.length/2;p+=1){for(y=(p+1)%a.length,i=a[p],r=a[y],n={x:r.y-i.y,y:i.x-r.x},m=[],u=0;u<t.length;u+=1)m.push(n.x*t[u].x+n.y*t[u].y);for(d=Math.min(...m),c=Math.max(...m),m=[],u=0;u<e.length;u+=1)m.push(n.x*e[u].x+n.y*e[u].y);if(f=Math.min(...m),h=Math.max(...m),c<f||h<d)return!1}return!0}}class Qt{constructor(){this.history=[],this.head=-1}get canUndo(){return this.head>0}get canRedo(){return this.head+1<this.history.length}save(t){this.history.push(t),this.head=this.history.length-1}undo(){return this.history.length===0?"":(this.head=Math.max(0,this.head-1),this.history[this.head])}redo(){return this.history.length===0?"":(this.head=Math.min(this.history.length-1,this.head+1),this.history[this.head])}}const Zt=(o,t)=>{let e=null;return(...a)=>{e!==null&&(clearTimeout(e),e=null),e=setTimeout(()=>o(...a),t)}},te=["Futura","FuturaBold","Courier New","Courier New Bold","Adobe Clean"],ee=[50,75,100,120],se=[50,100,120,150,175,200,250,300],ae=["Hello","Customize Me","Example","Edit Me","Sample"],ne=["F0F8FF","FAEBD7","00FFFF","7FFFD4","F0FFFF","F5F5DC","FFE4C4","000000","FFEBCD","0000FF","8A2BE2","A52A2A","DEB887","5F9EA0","7FFF00","D2691E","FF7F50","6495ED","FFF8DC","DC143C","00FFFF","00008B","008B8B","B8860B","A9A9A9","A9A9A9","006400","BDB76B","8B008B","556B2F","FF8C00","9932CC","8B0000","E9967A","8FBC8F","483D8B","2F4F4F","2F4F4F","00CED1","9400D3","FF1493","00BFFF","696969","696969","1E90FF","B22222","FFFAF0","228B22","FF00FF","DCDCDC","F8F8FF","FFD700","DAA520","808080","808080","008000","ADFF2F","F0FFF0","FF69B4","CD5C5C","4B0082","FFFFF0","F0E68C","E6E6FA","FFF0F5","7CFC00","FFFACD","ADD8E6","F08080","E0FFFF","FAFAD2","D3D3D3","D3D3D3","90EE90","FFB6C1","FFA07A","20B2AA","87CEFA","778899","778899","B0C4DE","FFFFE0","00FF00","32CD32","FAF0E6","FF00FF","800000","66CDAA","0000CD","BA55D3","9370DB","3CB371","7B68EE","00FA9A","48D1CC","C71585","191970","F5FFFA","FFE4E1","FFE4B5","FFDEAD","000080","FDF5E6","808000","6B8E23","FFA500","FF4500","DA70D6","EEE8AA","98FB98","AFEEEE","DB7093","FFEFD5","FFDAB9","CD853F","FFC0CB","DDA0DD","B0E0E6","800080","663399","FF0000","BC8F8F","4169E1","8B4513","FA8072","F4A460","2E8B57","FFF5EE","A0522D","C0C0C0","87CEEB","6A5ACD","708090","708090","FFFAFA","00FF7F","4682B4","D2B48C","008080","D8BFD8","FF6347","40E0D0","EE82EE","F5DEB3","FFFFFF","F5F5F5","FFFF00","9ACD32"],ie=[{url:"bird.jpg",width:725,height:1e3},{url:"modern-room.jpg",width:1152,height:1730},{url:"shadows.jpg",width:1288,height:1940}],oe=[.2,.3,.4];function H(o){return o[Math.floor(Math.random()*o.length)]}class St{static get color(){return H(ne)}static get placement(){return H(se)}static get fontId(){return H(te)}static get text(){return H(ae)}static get fontSize(){return H(ee)}static get imageData(){return H(ie)}static get imageScale(){return H(oe)}}function oa(o,t={}){o.dispatchEvent(new CustomEvent("documentEvent",{bubbles:!0,cancelable:!0,composed:!0,detail:t}))}function re(o){const t=new FileReader;return new Promise((e,s)=>{t.onerror=()=>{t.abort(),s(new DOMException("Problem parsing input file."))},t.onload=()=>{e(t.result)},t.readAsDataURL(o)})}async function Ft(o){const e=await(await fetch(o)).blob();return await re(e)}const Tt=o=>new Promise((t,e)=>{const s=new Image;s.onload=t,s.onerror=e,s.src=o});function Pt(o,t,e,s,a,n,i,r,d,c,l,p){const y=e,u=r.split(`
`),f=Mt(u,d,c,l),h=u.map(g=>(g.length-1)*p),m=f.map((g,b)=>g*i+h[b]);if(s=u.length*i,e=Math.max(...m),Math.abs(e-y)>1){const g=y-e;let b=0;n==="center"?b=g/2:n==="right"&&(b=g);const I={x:b,y:0},S=x.rotatePoint(I,a);o=o+S.x,t=t+S.y}return{x:o,y:t,width:e,height:s}}function C(o,t){return typeof o=="undefined"?t:o}function de(o){return o.includes(".png")?o.replace(".png","_sm.png"):`${o}_sm.png`}const ht="1.0";class ut{static makeNodeObject({type:t="container",isEffect:e=!1,isEffectNode:s=!1,variantSetId:a="",substance:n={},blendMode:i="normal",parentId:r="",width:d=0,height:c=0,x:l=0,y:p=0,rotate:y=0,data:u={}},f){return{id:f||$(),data:u,type:t,isEffect:e,isEffectNode:s,variantSetId:a,substance:n,blendMode:i,parentId:r,width:d,height:c,x:l,y:p,rotate:y,children:[],effects:[],items:[]}}static createNewDocumentState(){const t=this.makeNodeObject({type:"canvas"}),e=this.makeNodeObject({parentId:t.id,type:"artboard",width:600,height:600,x:-300,y:-300,data:{name:"Artboard 1"}});t.children.push(e.id);const s={id:$(),author:"",tool:"",name:"",thumbnail:"",extraThumbnails:[],tags:[],formatVersion:ht,versionTag:$(),rootNodeId:t.id,nodes:{},timelineDuration:5};return s.nodes[t.id]=t,s.nodes[e.id]=e,s}constructor(t){this.CargoDocumentIndexModel=t,this._state=ut.createNewDocumentState(),typeof this._state.author=="undefined"&&(this._state.author=""),typeof this._state.tool=="undefined"&&(this._state.tool=""),typeof this._state.name=="undefined"&&(this._state.name=""),typeof this._state.thumbnail=="undefined"&&(this._state.thumbnail=""),typeof this._state.extraThumbnails=="undefined"&&(this._state.extraThumbnails=[]),typeof this._state.tags=="undefined"&&(this._state.tags=[]),this.stringifiedState=""}async hydrateFromStorageService(t){const e=await this.CargoDocumentIndexModel.read(t);return typeof e.id=="string"&&(e.id=t,this._state=e,typeof this._state.author=="undefined"&&(this._state.author=""),typeof this._state.tool=="undefined"&&(this._state.tool=""),typeof this._state.name=="undefined"&&(this._state.name=""),typeof this._state.thumbnail=="undefined"&&(this._state.thumbnail=""),typeof this._state.extraThumbnails=="undefined"&&(this._state.extraThumbnails=[]),typeof this._state.tags=="undefined"&&(this._state.tags=[]),this.coerceValidNodeTree(),this.dirtyState()),this.state}coerceValidNodeTree(){const t=this._state.rootNodeId;if(!t)return;const e=this._state.nodes,s=e[t];if(!s){console.warn("NO ROOT NODE");return}for(const[a,n]of Object.entries(this._state.nodes))if(n.type==="variant-set"){const i=[];let r=!1;if([...n.items].forEach((d,c)=>{const l=e[d];l?(i.push(d),l.parentId&&(r=!0)):console.warn("BAD JSON STRUCTURE: MISSING VARIANT ITEM, DROPPING FROM SET")}),n.items=i,!r&&n.items.length>0){const d=n.items[0],c=e[d];c.parentId=t,s.children.push(d),console.warn("BAD JSON STRUCTURE: VARIANT SET HAS NO ITEM IN DISPLAY TREE, ADDING FIRST")}}for(const[a,n]of Object.entries(this._state.nodes)){if(n.type==="canvas")continue;if(n.type==="variant-set"){const r=[];[...n.items].forEach((d,c)=>{e[d]?r.push(d):console.warn("BAD JSON STRUCTURE: MISSING VARIANT ITEM, DROPPING FROM SET")}),n.items=r,n.items.length===0&&(console.warn("BAD JSON STRUCTURE: VARIANT SET HAS NO ITEMS, DROPPING IT"),delete this._state.nodes[a]);continue}if(!n.parentId&&n.variantSetId)continue;n.parentId||(n.parentId=t,console.warn("BAD JSON STRUCTURE: MISSING PARENT ID, ADDING TO ROOT"));const i=e[n.parentId];i.children.indexOf(a)===-1&&(console.warn("BAD JSON STRUCTURE: MISSING CHILD REFERENCE, ADDING TO CHILDREN"),i.children.push(a))}}async saveToStorageService(){const t=this.state,e=t.id;await this.CargoDocumentIndexModel.update(e,t)}async duplicateToStorageService(){this._state.id=`kit_x_${$()}`,this.dirtyState(),await this.saveToStorageService()}setAuthor(t){this._state.author=t,this.dirtyState()}setTool(t){this._state.tool=t,this.dirtyState()}setName(t){this._state.name=t,this.dirtyState()}setThumbnail(t){this._state.thumbnail=t,this.dirtyState()}setTags(...t){this._state.tags=t,this.dirtyState()}setExtraThumbnails(...t){this._state.extraThumbnails=t,this.dirtyState()}setStringifiedState(t){!t||(this._state=JSON.parse(t),typeof this._state.formatVersion=="undefined"&&(this._state.formatVersion=ht),typeof this._state.author=="undefined"&&(this._state.author=""),typeof this._state.name=="undefined"&&(this._state.name=""),typeof this._state.thumbnail=="undefined"&&(this._state.thumbnail=""),typeof this._state.tags=="undefined"&&(this._state.tags=[]),this.dirtyState())}forEachNode(t){Object.values(this._state.nodes).forEach(t)}hasNode(t){return this._state.nodes.hasOwnProperty(t)}findAll(t){const e=[];return this.forEachNode(s=>{t(s)&&e.push(s.id)}),e}find(t){let e="";const s=Object.values(this._state.nodes);for(let a=0;a<s.length;a++){const n=s[a];if(t(n)){e=n.id;break}}return e}ancestors(t){let s=this._state.nodes[t].parentId;const a=[];for(;s;)s=this._state.nodes[s].parentId,a.push(s);return a}findAncestor(t,e){let a=this._state.nodes[t].parentId,n="";for(;a;){const i=this._state.nodes[a];if(e(i)){n=a;break}a=i.parentId}return n}dirtyState(){this.stringifiedState=""}createNode({parentId:t,type:e,isEffect:s,isEffectNode:a,data:n,blendMode:i,x:r,y:d,width:c,height:l,index:p,rotate:y},u){const f=ut.makeNodeObject({parentId:t,type:e,isEffect:s,isEffectNode:a,data:n,blendMode:i,x:r,y:d,width:c,height:l,rotate:y},u);if(this._state.nodes[f.id]=f,t){const h=this._state.nodes[t],m=f.isEffect?"effects":"children";try{typeof p=="number"?h[m].splice(p,0,f.id):h[m].push(f.id)}catch{}}return this.dirtyState(),f.id}addNodeIdToVariantSet(t,e){this._state.nodes[t].items.push(e),this.updateNode(e,{variantSetId:t}),this.dirtyState()}swapActiveVariant(t,e){const a=this._state.nodes[t].parentId,i=this._state.nodes[a].children.indexOf(t);this.updateNode(e,{parentId:a,index:i}),this.updateNode(t,{parentId:""}),this.dirtyState()}activateVariant(t){const e=this._state.nodes[t].variantSetId,s=this.find(a=>!!(a.variantSetId===e&&a.parentId));t!==s&&this.swapActiveVariant(s,t)}removeItemFromVariantSet(t,e){const s=this._state.nodes[t],a=this._state.nodes[e];if(!s||!a)return;const n=s.items.indexOf(e);if(n!==-1){if(s.items.splice(n,1),a.parentId||this.updateNode(e,{parentId:this._state.rootNodeId}),s.items.length===1){const i=this._state.nodes[s.items[0]];this.updateNode(i.id,{variantSetId:""}),this.deleteNode(t)}this.dirtyState()}}deleteVariant(t,e){const s=this._state.nodes[t],a=this._state.nodes[e],n=s.items.indexOf(e);let i="";if(a.parentId){const r=n===s.items.length-1?0:n+1;i=s.items[r],this.swapActiveVariant(e,i)}if(n>-1&&s.items.splice(n,1),s.items.length===1){const r=this._state.nodes[s.items[0]];this.updateNode(r.id,{variantSetId:""}),this.deleteNode(t)}return this.deleteNode(e),this.dirtyState(),i}updateNode(t,{parentId:e,index:s,x:a,y:n,rotate:i,width:r,height:d,variantSetId:c,substance:l,blendMode:p,data:y},u=!0){const f=this._state.nodes[t],h=f.isEffect?"effects":"children";if((e||e==="")&&e!==f.parentId){const m=this._state.nodes[f.parentId];if(m){const b=m[h].indexOf(t);b>-1&&m[h].splice(b,1)}const g=this._state.nodes[e];g&&g[h].push(t),f.parentId=e}if(typeof s=="number"){const m=this._state.nodes[f.parentId],g=m[h].indexOf(f.id);m[h].splice(g,1),m[h].splice(Math.max(0,s),0,f.id)}return y&&Object.assign(f.data,y),c!==void 0&&(f.variantSetId=c),p!==void 0&&(f.blendMode=p),l!==void 0&&(f.substance=l),i!==void 0&&(f.rotate=Math.round(i*1e4)/1e4),a!==void 0&&(f.x=f.rotate===0&&u?Math.ceil(a):a),n!==void 0&&(f.y=f.rotate===0&&u?Math.ceil(n):n),r!==void 0&&(f.width=u?Math.floor(r):r),d!==void 0&&(f.height=u?Math.floor(d):d),this.dirtyState(),this}deleteNode(t){const e=this._state.nodes[t];if(!e)return this;const s=this._state.nodes[e.parentId],{children:a}=e;if([...a].forEach(this.deleteNode.bind(this)),s){const n=e.isEffect?"effects":"children",i=s[n].indexOf(t);i>-1&&s[n].splice(i,1)}return delete this._state.nodes[t],this.dirtyState(),this}duplicateNode(t){const e=this.getNode(t),s=this._state.nodes[e.parentId];let a=s.children.length,n="children";return s&&(n=e.isEffect?"effects":"children",a=s[n].indexOf(t)+1),this.createNode({parentId:e.parentId,type:e.type,isEffect:e.isEffect,isEffectNode:e.isEffectNode,data:e.data,blendMode:e.blendMode,x:e.x,y:e.y,width:e.width,height:e.height,index:a,rotate:e.rotate})}getNode(t){const e=this._state.nodes[t];return e?JSON.parse(JSON.stringify(e)):null}traverseSubtreeOfNode(t,e){const a=[...this._state.nodes[t].children];for(;a.length;){const n=a.shift(),i=this._state.nodes[n];e(i),a.push(...i.children)}}traverseSubtreeOfNode_PACK_STOP(t,e){const s=this._state.nodes[t];if(!s)return;const a=[...s.children];for(;a.length;){const n=a.shift(),i=this._state.nodes[n];e(i),i.type!=="pack"&&a.push(...i.children)}}listOfNodeIdsInSubtree(t){const e=[];return this.traverseSubtreeOfNode(t,s=>e.push(s.id)),e}listOfNodeIdsInSubtree_PACK_STOP(t){const e=[];return this.traverseSubtreeOfNode_PACK_STOP(t,s=>e.push(s.id)),e}getNodeType(t){const e=this._state.nodes[t];return e?e.type:""}getNodesOfType(t){return Object.values(this._state.nodes).filter(e=>e.type===t)}getNodeParentId(t){const e=this._state.nodes[t];return e?e.parentId:""}getChildCount(t){const e=this._state.nodes[t];return e?e.children.length:0}stringify(){return this.stringifiedState||(this._state.versionTag=$(),this.stringifiedState=JSON.stringify(this._state)),this.stringifiedState}get rootNodeId(){return this._state.rootNodeId}get state(){return JSON.parse(this.stringify())}}class at{static makeNodeObject({id:t=$(),type:e="container",isEffect:s=!1,isEffectNode:a=!1,variantSetId:n="",substance:i={},blendMode:r="normal",parentId:d="",width:c=0,height:l=0,x:p=0,y=0,rotate:u=0,data:f={}}){return{id:t,data:f,type:e,isEffect:s,isEffectNode:a,variantSetId:n,substance:i,blendMode:r,parentId:d,width:c,height:l,x:p,y,rotate:u,children:[],effects:[],items:[],dataCacheKey:"",placementCacheKey:"",sizeCacheKey:"",index:0,globalTransform:_.defaultMatrix}}static createNewDocumentState(){const t=this.makeNodeObject({type:"canvas"}),e={id:$(),versionTag:$(),formatVersion:ht,rootNodeId:t.id,timelineDuration:0,nodes:{},author:"",tool:"",name:"",thumbnail:"",extraThumbnails:[],tags:[]};return e.nodes[t.id]=t,e}constructor(t=""){this.state=t?JSON.parse(t):at.createNewDocumentState()}preorderTraversal(t){const e=[this.state.rootNodeId];for(;e.length;){const s=e.shift(),a=this.state.nodes[s];e.push(...a.children),t(a)}}depthFirstTraversal(t){const e=[this.state.rootNodeId],s=[];for(;e.length>0;){const a=e.pop(),n=this.state.nodes[a];s.indexOf(a)>=0||n.children.length===0?t(n):(s.push(a),e.push(a,...n.children))}}indexOfChildWithinParent(t,e){const{children:s}=this.state.nodes[e];return s.indexOf(t)}setStringifiedState(t){!t||(this.state=JSON.parse(t))}forEachNode(t){Object.values(this.state.nodes).forEach(t)}findAll(t){const e=[];return this.forEachNode(s=>{t(s)&&e.push(s.id)}),e}forceInsertionAsParent(t,e){const s=this.state.nodes[t],a=this.state.nodes[e],n=this.state.nodes[a.parentId],i=n.children.indexOf(e);i>=0&&n.children.splice(i,1),a.parentId=t,s.children.push(e)}createNode({id:t,parentId:e,type:s,isEffect:a,isEffectNode:n,data:i,blendMode:r,x:d,y:c,width:l,height:p,index:y,rotate:u}){e||(e=this.state.rootNodeId);const f=this.state.nodes[e],h=at.makeNodeObject({id:t,parentId:e,type:s,isEffect:a,isEffectNode:n,data:i,blendMode:r,x:d,y:c,width:l,height:p,rotate:u});this.state.nodes[h.id]=h;const m=h.isEffect?"effects":"children";return typeof y=="number"?f.children.splice(y,0,h.id):f[m].push(h.id),h.id}updateNode(t,{parentId:e,index:s,x:a,y:n,rotate:i,width:r,height:d,blendMode:c,data:l},p=!1){const y=this.state.nodes[t],u=!p&&y.isEffect?"effects":"children";if(e&&e!==y.parentId){const f=this.state.nodes[y.parentId],h=f[u].indexOf(t);h>-1&&f[u].splice(h,1);const m=this.state.nodes[e];y.parentId=e,m[u].push(t)}if(typeof s=="number"){const f=this.state.nodes[y.parentId],h=f[u].indexOf(y.id);f[u].splice(h,1),f[u].splice(s,0,y.id)}return l&&Object.assign(y.data,l),a!==void 0&&(y.x=a),n!==void 0&&(y.y=n),c!==void 0&&(y.blendMode=c),r!==void 0&&(y.width=r),d!==void 0&&(y.height=d),i!==void 0&&(y.rotate=i),this}deleteNode(t){const e=this.state.nodes[t],s=e.isEffect?"effects":"children",a=this.state.nodes[e.parentId],n=a[s].indexOf(t);return n>-1&&a[s].splice(n,1),delete this.state.nodes[t],this}get rootNodeId(){return this.state.rootNodeId}}class ce{constructor(){this._state={cacheKey:"",data:{src:""}},this._displayObject=new st,this.isLoaded=!1,this.isLoading=!1,this._loadedNaturalWidth=1,this._loadedNaturalHeight=1,this._renderPromise=Promise.resolve()}get displayObject(){return this._displayObject}get state(){return this._state}set state(t){const e=t.dataCacheKey!==this._state.dataCacheKey||t.sizeCacheKey!==this._state.sizeCacheKey,s=t.placementCacheKey!==this._state.placementCacheKey;this.isLoaded=this._state.data.src===t.data.src,this._state=t,s&&this.place(),e&&this.render()}load(){this.isLoading=!0,this._renderPromise=new Promise((t,e)=>{let s=this.state.data.src;s.indexOf("http")===0&&(s=`${s}?redir=1`);var a=new Image;a.crossOrigin="anonymous",a.onload=()=>{this.sprite&&this.sprite._texture&&(this.sprite.destroy(),delete this.sprite),this.isLoaded=!0,this.isLoading=!1,this._loadedNaturalWidth=a.naturalWidth,this._loadedNaturalHeight=a.naturalHeight;var n=new Ht(a),i=new Gt(n);this.sprite=new Wt(i),this._displayObject.addChild(this.sprite),this.render(),setTimeout(()=>{t(`${this._state.id}:${s}`)},20)},a.src=s})}place(){const{x:t,y:e,rotate:s}=this.state;this._displayObject.rotation=s,this._displayObject.position.set(t,e)}render(){if(!this.isLoaded&&!this.isLoading&&this.load(),this.sprite){const{blendMode:t,width:e,height:s}=this.state,a=e/this._loadedNaturalWidth,n=s/this._loadedNaturalHeight;switch(t){case"multiply":this.sprite.blendMode=P.MULTIPLY;break;case"screen":this.sprite.blendMode=P.SCREEN;break;default:this.sprite.blendMode=P.NORMAL;break}this.sprite.scale.set(a,n)}}}class le{constructor(){this._state={cacheKey:""},this._displayObject=new qt(""),this._renderScale=1}get state(){return this._state}get displayObject(){return this._displayObject}set state(t){const e=t.dataCacheKey!==this._state.dataCacheKey||t.sizeCacheKey!==this._state.sizeCacheKey,s=t.placementCacheKey!==this._state.placementCacheKey;this._state=t,s&&this.place(),e&&this.render()}set renderScale(t){let e=1;t<1?e=Math.ceil(t*2)/2:e=Math.min(4,Math.ceil(t)),e!==this._renderScale&&(this._renderScale=e,this._displayObject.resolution=this._renderScale)}place(){const{x:t,y:e,rotate:s}=this.state;this._displayObject.rotation=s,this._displayObject.position.set(t,e)}render(){const{blendMode:t,data:{text:e,color:s,font:a,weight:n,style:i,size:r,letterSpacing:d,alignment:c}}=this.state;switch(t){case"multiply":this._displayObject.blendMode=P.MULTIPLY;break;case"screen":this._displayObject.blendMode=P.SCREEN;break;default:this._displayObject.blendMode=P.NORMAL;break}this._displayObject.text=e,this._displayObject.style={fontFamily:a,fontSize:r,fontStyle:i,fontWeight:n,lineHeight:r,textBaseline:"bottom",padding:Math.round(r/2),fill:B(s||"0099ff"),align:c,letterSpacing:d}}}class he{constructor(){this._state={cacheKey:""},this._displayObject=new Q}get state(){return this._state}get displayObject(){return this._displayObject}set state(t){const e=t.dataCacheKey!==this._state.dataCacheKey||t.sizeCacheKey!==this._state.sizeCacheKey,s=t.placementCacheKey!==this._state.placementCacheKey;this._state=t,s&&this.place(),e&&this.render()}place(){const{x:t,y:e,rotate:s}=this.state;this._displayObject.rotation=s,this._displayObject.position.set(t,e)}render(){const{width:t,height:e,blendMode:s,data:{color:a,borderColor:n,borderSize:i,borderRadius:r}}=this.state;switch(s){case"multiply":this._displayObject.blendMode=P.MULTIPLY;break;case"screen":this._displayObject.blendMode=P.SCREEN;break;default:this._displayObject.blendMode=P.NORMAL;break}this._displayObject.clear(),this._displayObject.beginFill(B(a||"0099ff")),i>0&&this._displayObject.lineStyle({width:i,color:B(n||"0099ff"),alignment:1,alpha:1,native:!1,cap:ft.BUTT,join:yt.MITER,miterLimit:10}),r>0?this._displayObject.drawRoundedRect(0,0,t,e,r):this._displayObject.drawRect(0,0,t,e),this._displayObject.endFill()}}class ue{constructor(){this._state={cacheKey:""},this._displayObject=new Q}get state(){return this._state}get displayObject(){return this._displayObject}set state(t){const e=t.dataCacheKey!==this._state.dataCacheKey||t.sizeCacheKey!==this._state.sizeCacheKey,s=t.placementCacheKey!==this._state.placementCacheKey;this._state=t,s&&this.place(),e&&this.render()}place(){const{x:t,y:e,rotate:s}=this.state;this._displayObject.rotation=s,this._displayObject.position.set(t,e)}render(){const{blendMode:t,width:e,height:s,data:{color:a,borderColor:n,borderSize:i}}=this.state;switch(t){case"multiply":this._displayObject.blendMode=P.MULTIPLY;break;case"screen":this._displayObject.blendMode=P.SCREEN;break;default:this._displayObject.blendMode=P.NORMAL;break}this._displayObject.clear(),this._displayObject.beginFill(B(a||"0099ff")),i>0&&this._displayObject.lineStyle({width:i,color:B(n||"0099ff"),alignment:1,alpha:1,native:!1,cap:ft.BUTT,join:yt.MITER,miterLimit:10}),this._displayObject.drawEllipse(e/2,s/2,e/2,s/2),this._displayObject.endFill()}}class pe{constructor(){this._state={cacheKey:""},this._displayObject=new Q}get state(){return this._state}get displayObject(){return this._displayObject}set state(t){const e=t.dataCacheKey!==this._state.dataCacheKey||t.sizeCacheKey!==this._state.sizeCacheKey,s=t.placementCacheKey!==this._state.placementCacheKey;this._state=t,s&&this.place(),e&&this.render()}place(){const{x:t,y:e,rotate:s}=this.state;this._displayObject.rotation=s,this._displayObject.position.set(t,e)}render(){const{blendMode:t,width:e,height:s,data:{color:a,borderColor:n,borderSize:i}}=this.state;switch(t){case"multiply":this._displayObject.blendMode=P.MULTIPLY;break;case"screen":this._displayObject.blendMode=P.SCREEN;break;default:this._displayObject.blendMode=P.NORMAL;break}this._displayObject.clear(),this._displayObject.beginFill(B(a||"0099ff")),i>0&&this._displayObject.lineStyle({width:i,color:B(n||"0099ff"),alignment:1,alpha:1,native:!1,cap:ft.BUTT,join:yt.MITER,miterLimit:10}),this._displayObject.drawCircle(e/2,s/2,e/2),this._displayObject.endFill()}}class mt{constructor(){this._state={cacheKey:""},this._displayObject=new st}get state(){return this._state}get displayObject(){return this._displayObject}get childrenSlot(){return this._displayObject}set state(t){const e=t.placementCacheKey!==this._state.placementCacheKey;this._state=t,e&&this.place()}place(){const{x:t,y:e,rotate:s}=this.state;this.displayObject.rotation=s,this.displayObject.position.set(t,e)}}class fe{constructor(){this._state={cacheKey:""},this._displayObject=new st,this._childrenSlot=new st,this._background=new Q,this._mask=new Q,this._displayObject.addChild(this._mask),this._displayObject.addChild(this._background),this._displayObject.addChild(this._childrenSlot),this._childrenSlot.mask=this._mask}get state(){return this._state}get displayObject(){return this._displayObject}get childrenSlot(){return this._childrenSlot}set state(t){const e=t.dataCacheKey!==this._state.dataCacheKey||t.sizeCacheKey!==this._state.sizeCacheKey,s=t.placementCacheKey!==this._state.placementCacheKey;this._state=t,s&&this.place(),e&&this.render()}place(){const{x:t,y:e,rotate:s}=this.state;this.displayObject.rotation=s,this.displayObject.position.set(t,e)}render(){const{width:t,height:e,data:{color:s}}=this.state;this._background.clear(),this._background.beginFill(B(s||"0099ff")),this._background.drawRect(0,0,t,e),this._background.endFill(),this._mask.clear(),this._mask.drawRect(0,0,t,e)}}class ye{constructor(){this._state={cacheKey:""},this._displayObject=new st,this._mask=new Q,this._displayObject.addChild(this._mask),this.displayObject.mask=this._mask}get state(){return this._state}get displayObject(){return this._displayObject}get childrenSlot(){return this._displayObject}set state(t){const e=t.placementCacheKey!==this._state.placementCacheKey,s=t.sizeCacheKey!==this._state.sizeCacheKey;this._state=t,e&&this.place(),s&&this.resize()}place(){const{x:t,y:e,rotate:s}=this.state;this.displayObject.rotation=s,this.displayObject.position.set(t,e)}resize(){const{width:t,height:e}=this.state;this._mask.clear(),this._mask.beginFill(0),this._mask.drawRect(0,0,t,e)}}const j=new Map;j.set("image",ce);j.set("text",le);j.set("rectangle",he);j.set("ellipse",ue);j.set("circle",pe);j.set("container",mt);j.set("artboard",fe);j.set("artboard-group",mt);j.set("pack",ye);j.set("canvas",mt);function me(o){const t=j.get(o);return new t}class ge{constructor(t={}){this._width=1,this._height=1,this._scale=1,this._originX=0,this._originY=0,this._displayList={},this._displayGraph=at.createNewDocumentState(),this._pixiApp=new Xt(t),this._stage=this._pixiApp.stage}get canvas(){return this._pixiApp.view}set displayGraph(t){this._displayGraph=t}set canvasSize({width:t,height:e}){this._pixiApp.renderer.resize(t,e)}set origin({x:t,y:e}){this._stage.x=t,this._stage.y=e}set rootId(t){this._rootId=t}set scale(t){this._scale=t}async render(){const t=[],e=this._rootId||this._displayGraph.rootNodeId;if(!this._displayGraph.nodes[e])return;const s=Object.keys(this._displayList),a=[e];for(this._stage.scale.set(this._scale);a.length;){const n=a.shift(),i=this._displayGraph.nodes[n],r=n===e?0:i.index;a.push(...i.children);const d=i.id,c=s.indexOf(d);c>-1&&s.splice(c,1);let l=this._displayList[d];const p=this._displayList[i.parentId],y=p?p.childrenSlot:this._stage;l||(l=me(i.type),this._displayList[d]=l),y.addChildAt(l.displayObject,r),l.renderScale=this._scale,l.state=i,l._renderPromise&&t.push(l._renderPromise)}return s.forEach(n=>{if(n===this._displayGraph.rootNodeId)return;const i=this._displayList[n];delete this._displayList[n],setTimeout(()=>{const{displayObject:r}=i;r&&!r._destroyed&&r.destroy({children:!0,texture:!0,baseTexture:!0})},0)}),Promise.all(t)}}const L="Preset",X="Template",be="display_nodes",Se="async_display_nodes",gt="https://substance-api-int-eastus.azcloud.prod.substance3d.io",Et=`${gt}/tempfiles`,_t=10;function _e(o){const t=new FileReader;return new Promise((e,s)=>{t.onerror=()=>{t.abort(),s(new DOMException("Problem parsing input file."))},t.onload=()=>{e(t.result)},t.readAsDataURL(o)})}const ot=new Map,rt=new Map,dt=new Map;async function Ne(o){const s=(await(await fetch(o)).json()).file,n=await(await fetch(s)).blob(),i=new File([n],"file.sbsar",{type:"application/vnd.adobe.sbsar"}),r=new FormData;return r.append("files",i,"file.sbsar"),(await(await fetch(Et,{method:"POST",body:r})).json()).id}async function Ie(o,t){const s=t.split(";")[0].split(":")[1].split("/")[1],n=await(await fetch(t)).blob(),i=new FormData;return i.append("files",n,`${o}.${s}`),(await(await fetch(Et,{method:"POST",body:i})).json()).id}async function Dt(o){return ot.has(o)||ot.set(o,Ne(o)),ot.get(o)}async function we(o){const t=await Dt(o);return t?await(await fetch(`${gt}/substances/file:${t}`)).json():{}}async function ve(o){return o?(rt.has(o)||rt.set(o,we(o)),rt.get(o)):{}}async function xe(o){return(await ve(o)).presets||[]}async function Me(o,t){return dt.has(o)||dt.set(o,Ie(o,t)),dt.get(o)}async function Oe(o,t,e){let s=`${gt}/substances/file:${o}/channels/basecolor?$outputsize=${_t},${_t}&format=png&image1=file:${t}`;s=Object.keys(e).reduce((r,d)=>`${r}&${d}=${e[d]}`,s);const n=await(await fetch(s)).blob();return await _e(n)}async function Ct(o,t,e,s={}){const a=await Dt(e),n=await xe(e),i=await Me(o,t);return s.preset||(s.preset=n.length>0?n[0].name:""),await Oe(a,i,s)}const Nt=2.5,It=360/16;class J{static get defaultData(){return{}}static create(t,{documentModel:e},s){return t.data=Object.assign(this.defaultData,t.data),e.createNode(t,s)}static update(t,e,{documentModel:s},a=!0,n=!1){return s.updateNode(t,e,a)}static delete(t,{documentModel:e}){return e.deleteNode(t)}static convertRawGestureToNodeRelativeTotalDeltaVector(t,e,s,a,n){const{editorModel:{_state:{renderScale:i}}}=n,r=a.nodes[e],{totalDeltaX:d,totalDeltaY:c}=s;let l=r,p=0;for(;l&&l.type!=="canvas";)p+=l.rotate,l=a.nodes[l.parentId];const y={x:d/i,y:c/i};return x.rotatePoint(y,-p)}static snaplinesOfNode({width:t,height:e,globalTransform:s}){const a=_.transformPoint(0,0,s),n=_.transformPoint(t,0,s),i=_.transformPoint(t,e,s),r=_.transformPoint(0,e,s);return[[a,n],[n,i],[i,r],[r,a]]}static centroidOfNode({x:t,y:e,width:s,height:a,rotate:n}){return x.rotatePoint({x:t+s/2,y:e+a/2},n,{x:t,y:e})}static adjustBounds(t,e,s,a,n,i,r){const d=n.nodes[e];if(!d)return;const c=this.centroidOfNode(d),{x:l,y:p,width:y,height:u,rotate:f}=d,h={};let m=!0;switch(t){case"translate":h.x=l+s.x,h.y=p+s.y;break;case"rotate":m=!1;const v={x:0,y:40+u/2},F={x:v.x+s.x,y:v.y-s.y},D=x.radiansBetweenPoints({x:0,y:0},v),T=x.radiansBetweenPoints({x:0,y:0},F),K=D-T,V=f+K,R={x:-y/2,y:u/2},Y=x.rotatePoint(R,-K),Z=x.vectorBetweenPoints(Y,R),O=x.rotatePoint(Z,-f);h.x=l+O.x,h.y=p-O.y,h.rotate=V;break;case"ne":case"se":case"e":h.width=y+s.x,h.width&&h.width<0&&(h.x=l+h.width,h.width=-h.width);break;case"nw":case"sw":case"w":h.x=l+s.x,h.width=y-s.x,h.width&&h.width<0&&(h.x=l+y,h.width=-h.width);break}switch(t){case"nw":case"n":case"ne":h.y=p+s.y,h.height=u-s.y,h.height&&h.height<0&&(h.y=p+u,h.height=-h.height);break;case"sw":case"s":case"se":h.height=u+s.y,h.height&&h.height<0&&(h.y=p+h.height,h.height=-h.height);break}const g=typeof h.x=="number",b=typeof h.y=="number";if((g||b)&&t!=="rotate"){const v={x:(g?h.x:l)-l,y:(b?h.y:p)-p},F=x.rotatePoint(v,f);h.x=l+F.x,h.y=p+F.y}const I=typeof h.x=="number"?h.x:l,S=typeof h.y=="number"?h.y:p,w=typeof h.rotate=="number"?h.rotate:f;let N=n.nodes[d.parentId],E=w;for(;N&&N.type!=="canvas";)E+=N.rotate,N=n.nodes[N.parentId];const A=(x.degrees(E)%360+360)%It,z=Math.min(A,Math.abs(A-It));if(z<Nt){const v=x.radians(z),F=A>Nt?v:-v;h.rotate=w+F;const{x:D,y:T}=x.rotatePoint({x:I,y:S},F,c);h.x=D,h.y=T}this.update(e,h,r,m)}}class Fe extends J{static get defaultData(){return{}}}class Te extends J{static get defaultData(){return{name:"",color:"#FFFFFF",borderRadius:0,borderSize:0,borderColor:"#CCCCCC"}}static create(t,e){return t.data=t.data||{},t.width=324,t.height=200,super.create(t,e)}}class Pe extends J{static get defaultData(){return{name:"",color:"#000000",fontLabel:"",font:"Futura",weight:"normal",style:"normal",size:40,letterSpacing:0,alignment:"left",text:"default"}}static create(t,e,s){t.data=t.data||{},t.data=Object.assign(this.defaultData,t.data,s);const{size:a,text:n,font:i,weight:r,style:d,letterSpacing:c}=t.data,l=n.split(`
`),p=Mt(l,i,r,d),y=l.map(f=>(f.length-1)*c),u=p.map((f,h)=>f*a+y[h]);return t.height=l.length*a,t.width=Math.max(...u),super.create(t,e)}static update(t,e,s,a=!0){const{data:n}=e,i=s.documentModel._state.nodes[t];if(n&&(n.hasOwnProperty("text")||n.hasOwnProperty("font")||n.hasOwnProperty("weight")||n.hasOwnProperty("style")||n.hasOwnProperty("size")||n.hasOwnProperty("letterSpacing"))){const{x:r,y:d,width:c,height:l}=Pt(C(e.x,i.x),C(e.y,i.y),C(e.width,i.width),C(e.height,i.height),C(e.rotate,i.rotate),C(n.alignment,i.data.alignment),C(n.size,i.data.size),C(n.text,i.data.text),C(n.font,i.data.font),C(n.weight,i.data.weight),C(n.style,i.data.style),C(n.letterSpacing,i.data.letterSpacing));e.x=r,e.y=d,e.width=c,e.height=l}return s.documentModel.updateNode(t,e,a)}}class nt extends J{static convertRawGestureToNodeRelativeTotalDeltaVector(t,e,s,a,n){const i=a.nodes[e],{width:r,height:d}=i;let c=super.convertRawGestureToNodeRelativeTotalDeltaVector(t,e,s,a,n);const l={x:0,y:0};let p=c;switch(t){case"ne":p={x:r,y:-d};break;case"se":p={x:-r,y:-d};break;case"sw":p={x:-r,y:d};break;case"nw":p={x:r,y:d};break}return c=x.closestPointOfLineToAPoint(c,l,p),c}}function Ee(o){return!!(o.data&&(typeof o.data.substance!="undefined"||typeof o.data.substanceConfig!="undefined"))}function jt(o,t,e){return`${t}:${JSON.stringify(e)}`}function wt(o,t,e){const{data:{src:s,originalSrc:a,substance:n,substanceConfig:i}}=e.documentModel.getNode(t);return o===jt(a||s,n,i)}class De extends nt{static get defaultData(){return{name:"",src:"/files/default.jpg",substanceName:"",substance:"",substanceConfig:{},originalSrc:"",aspectRatio:1,nativeWidth:1,nativeHeight:1}}static create(t,e,s){return t.data=t.data||{},t.data=Object.assign(this.defaultData,t.data,s),super.create(t,e)}static update(t,e,s,a=!0,n){const i=e.data&&e.data.src;let r="";if(i&&(r=e.data.src,e.data.originalSrc=""),i||Ee(e)){const{substance:d,substanceConfig:c}=e.data,l=s.documentModel.getNode(t),p=l.data.substance,y=l.data.substanceConfig,u=typeof d!="undefined"?d:p,f=typeof c!="undefined"?c:y,h=r||l.data.originalSrc||l.data.src;if((i||!p&&u)&&(e.data.originalSrc=h),p&&!u&&(s.editorModel.removeLoading(t),e.data.src=h,e.data.originalSrc=""),u){s.editorModel.addLoading(t);const m=jt(h,u,f);Promise.all([Ot(u),Ft(h)]).then(([g,b])=>Ct(h,b,g,f)).then(g=>{if(!wt(m,t,s))throw new Error("Invalid Substance key");return zt(g)}).then(g=>pt(g)).then(g=>Tt(g.url).then(()=>g)).then(g=>{if(!wt(m,t,s))throw new Error("Invalid Substance key");super.update(t,{data:{src:g.url}},s,a,n),s.renderCallback(),s.editorModel.removeLoading(t)}).catch(()=>{console.info("SUBSTANCE APPLICATION FAILED"),s.renderCallback(),s.editorModel.removeLoading(t),super.update(t,{data:{substance:p,substanceConfig:y}},s,a,n),alert("SUBSTANCE APPLICATION FAILED")})}}return super.update(t,e,s,a,n)}}class Ce extends J{static get defaultData(){return{name:"",color:"#FFFFFF",borderSize:0,borderColor:"#CCCCCC"}}static create(t,e,s){return t.data=t.data||{},t.width=200,t.height=324,super.create(t,e,s)}}class je extends nt{static get defaultData(){return{isMask:!0,name:"",color:"#FFFFFF",borderSize:0,borderColor:"#CCCCCC"}}static create(t,e){return t.data=t.data||{},t.width=200,t.height=200,super.create(t,e)}}class ke extends J{static get defaultData(){return{name:"artboard",color:"#FFFFFF"}}static create(t,e,s){t.data=t.data||{},t.parentId||(t.parentId=e.documentModel._state.rootNodeId);const a=e.documentModel.findAll(i=>i.type==="artboard"),n=a.length;if(!t.data.name){const i=`Artboard ${n+1}`;t.data.name=i}if((!t.width||!t.height)&&(t.width=600,t.height=600),t.x=-t.width/2,t.y=-t.height/2,n>0){const i=e.documentModel.getNode(a[n-1]);t.x=i.x+i.width+100,t.y=i.y}return super.create(t,e,s)}}function Re(o,t){if(t.value){const e=o.data[t.value];if(e)return e}}function Ae(o,t,e){if(e&&e[t.id]){let s=e[t.id];return(s.type==="packDataKey"||!s.type&&typeof s.value=="string"&&o.data[s.value])&&(s=o.data[s.value]),s}}function Ke(o,t,e){if(e&&e[L]){let s=e[L];s.type==="packDataKey"&&(s=o.data[s.value]);let a=s.value[t.id];if(o.data[a])return o.data[a]}}function kt(o,t,e){const s=Ae(o,t,e);if(s)return s;const a=Ke(o,t,e);if(a)return a;const n=Re(o,t);if(n)return n}function Ve(o,t){if(t.value)return t.value}function $e(o,t,e){if(e&&e[t.id])return e[t.id].value}function Le(o,t,e){if(e&&e[L]){let s=e[L];s.type==="packDataKey"&&(s=o.data[s.value]);let a=s.value[t.id];if(o.data[a])return a}}function Be(o,t,e){const s=$e(o,t,e);if(s)return s;const a=Le(o,t,e);if(a)return a;const n=Ve(o,t);if(n)return n}function Je(o,t,e){const s={label:"",thumbnail:""},a=typeof o.value=="object"?JSON.stringify(o.value):o.value;if(e){const n=e.find(i=>{let r="";if(typeof i.value=="string"&&t[i.value]){const d=t[i.value];r=typeof d.value=="object"?JSON.stringify(d.value):d.value}else r=typeof i.value=="object"?JSON.stringify(i.value):i.value;return a===r});n&&(s.label=n.label,s.thumbnail=n.thumbnail||"")}else switch(o.type){case"color":s.label=o.value;break;case"text":s.label=`${o.value.slice(0,12)}${o.value.length>12?"...":""}`;break;case"image":const n=typeof o.value=="string"?o.value:o.value.src;s.thumbnail=de(n);break;default:s.label=o.type}return s}function Ue(o,t){const e=[],{type:s,data:a,x:n,y:i,width:r,height:d,rotate:c}=o;switch(s){case"pack":const l=a.packConfig,p=a.packInputs;l.inputs.forEach(S=>{if(S.hidden===!0)return;const w=Be(l,S,p);if(S.options&&S.options.length>1){S.options.forEach(T=>{let K=w===T.value;e.push({recipe:`Pack Input:-:${S.id}`,value:{artboardIds:K?[t]:[],uniquenessKey:`${S.label}:${JSON.stringify(T.value)}`,type:S.type,label:T.label,thumbnail:T.thumbnail,value:T.value}})});return}const N=p[S.id];let E=S.value,U=S.type||"packDataKey";N&&(E=N.value,U=N.type);const A=kt(a.packConfig,S,p);if(!A)return;const{label:z,thumbnail:v}=Je(A,l.data,S.options),F=z,D=v;e.push({recipe:`Pack Input:-:${S.id}`,value:{artboardIds:[t],uniquenessKey:`${U}:${JSON.stringify(E)}`,type:U,label:F,thumbnail:D,value:E}})});break;case"image":const y=a.originalSrc||a.src,u=y.replace(".png","_sm.png");if(e.push({recipe:"Image Source",value:{artboardIds:[t],uniquenessKey:y,type:"image",label:`Image ${o.id}`,thumbnail:u,value:{src:y,width:a.nativeWidth,height:a.nativeHeight}}}),e.push({recipe:"Image And Placement",value:{artboardIds:[t],uniquenessKey:`${y}:${n}:${i}:${r}:${d}:${c}`,type:"image and placement",label:`Image ${o.id} ${n}:${i}`,thumbnail:u,value:{image:{src:y,width:a.nativeWidth,height:a.nativeHeight},placement:{width:r,height:d,x:n,y:i,rotate:c}}}}),a.substance){const S=a.substance,w=a.src.replace(".png","_sm.png"),N=JSON.stringify(o.data.substanceConfig);e.push({recipe:"Substance Filter",value:{artboardIds:[t],uniquenessKey:`${S}:${N}`,type:"substance filter",label:o.data.substance,thumbnail:w,value:{id:S,params:JSON.parse(N)}}})}break;case"text":e.push({recipe:"Text",value:{artboardIds:[t],uniquenessKey:a.text,type:"text",label:a.text.slice(0,24),value:a.text}}),e.push({recipe:"Fill Color",value:{artboardIds:[t],uniquenessKey:a.color,type:"color",label:a.color,value:a.color}});const{font:f,weight:h,style:m,size:g,letterSpacing:b,alignment:I}=a;e.push({recipe:"Text Style",value:{artboardIds:[t],uniquenessKey:`${f}:${h}:${m}:${g}:${b}:${I}`,type:"text style",label:`${f} ${h} ${m}`,value:{font:a.font,weight:a.weight,style:a.style,size:a.size,letterSpacing:a.letterSpacing,alignment:a.alignment}}});break;case"rectangle":case"ellipse":case"circle":e.push({recipe:"Fill Color",value:{artboardIds:[t],uniquenessKey:a.color,type:"color",label:a.color,value:a.color}});break}return e}function ze(o,t){const e=t.find(s=>s.uniquenessKey===o.uniquenessKey);if(e){o.artboardIds.length>0&&e.artboardIds.push.apply(e.artboardIds,o.artboardIds);return}t.push(o)}function Ye(o,t){t.find(s=>s.id===o.id)===void 0&&t.push(o)}function He(o,t){const e={};return t.traverseSubtreeOfNode_PACK_STOP(o,s=>{const{id:a,type:n,data:{name:i}}=s;n!=="artboard"&&i&&(typeof e[i]=="undefined"&&(e[i]=[]),e[i].push(a))}),e}function Ge(o,t){const{children:e=[]}=t._state.nodes[o];return e.filter(a=>t.getNodeType(a)==="artboard")}function Rt(o,t){let e=t.defaultGraphId;const s=o[X],a=o[L];if(s&&s.type==="packDataKey")e=s.value;else if(a&&a.type==="packDataKey"){const r=t.data[a.value].value[X];r&&(e=r)}return t.graphs[e]}function At(o,t){if(!t||!t.graphs)return{width:1,height:1};const e=Rt(o,t);return{width:e.width,height:e.height}}const We=()=>({}),Kt=new Map,Vt=new Map,$t=new Map;function qe(o,t){return function(e,s,a,n,i,r){const d=es(e),c={},l={};return o.forEach(p=>{c[p]=new Promise(y=>{l[p]=y})}),d.then(p=>{const y=t(p,s,a,n,i,r);Promise.resolve(y).then(u=>{Object.keys(u).forEach(f=>{l[f](u[f])})})}),c}}function k({type:o,inputs:t,outputs:e,callback:s}){Kt.set(o,t),Vt.set(o,e),$t.set(o,qe(e,s))}function Xe(o){return Kt.get(o)||[]}function Qe(o){return Vt.get(o)||[]}function Ze(o){return $t.get(o)||We}function ts(o,t,e,s){const a=[],n=s.nodes[o].type;return Qe(n).forEach(r=>{const d=t[r];if(typeof d=="undefined")return;const c=`${o}::${r}`;(s.adjacencyList[c]||[]).forEach(p=>{const[y,u]=p.split("::");e[y][u]=d,a.indexOf(y)===-1&&a.push(y)}),n==="for-each-begin"&&(delete e[o].accumulator,delete e[o].index)}),a}function vt(o,t){const e=Xe(o);for(let s=e.length-1;s>=0;s-=1)if(typeof t[e[s]]=="undefined")return!1;return!0}async function es(o){const t=Object.keys(o),e=Object.values(o);return(await Promise.allSettled(e)).reduce((a,n,i)=>(a[t[i]]=n.value,a),{})}const ss={"Image Source":["Image And Placement"],"Image And Placement":["Image Source"],"Substance Filter":["Substance Filter Config Attribute"],"Substance Filter Config Attribute":["Substance Filter"]};function Lt(o,t){const e={},s=He(o,t),a=Ge(o,t);e[L]={values:[],targets:[],conflictingSemanticKeys:[]},e[X]={values:[],targets:[],conflictingSemanticKeys:[]},a.forEach(n=>{const{id:i,data:{name:r}}=t._state.nodes[n];e[X].values.push({uniquenessKey:i,type:"template",label:r,value:i,artboardIds:[n]}),e[L].values.push({uniquenessKey:`${i}::preset`,type:"preset",label:r,value:i,artboardIds:[n]})});for(const[n,i]of Object.entries(s))i.forEach(r=>{const d=t._state.nodes[r],c=t.findAncestor(d.id,u=>u.type==="artboard"),{type:l,data:p}=d;Ue(d,c).forEach(({recipe:u,value:f})=>{const h=`${n} ${u}`;e[h]||(e[h]={values:[],targets:[],conflictingSemanticKeys:[]}),ze(f,e[h].values),Ye({id:r,type:l,recipe:u},e[h].targets)})});for(const[n,i]of Object.entries(e))n!==X&&i.values.length<2||i.targets.forEach(r=>{const d=r.recipe,c=ss[d]||[];for(const[l,p]of Object.entries(e))if(l!==n)for(let y=0;y<p.targets.length;y++){const u=p.targets[y];if(u.id===r.id){const f=u.recipe;c.indexOf(f)>=0&&i.conflictingSemanticKeys.indexOf(l)===-1&&i.conflictingSemanticKeys.push(l)}}});return e}class as extends nt{static get defaultData(){return{name:"Cargo Pack",semanticParameterConfiguration:{},packBuildOptions:{},publishedPackId:"",tags:[],author:"",tool:""}}static update(t,e,s,a,n){var d;const i=(d=e.data)==null?void 0:d.semanticParameterConfiguration;if(typeof i!="undefined"){const c=Lt(t,s.documentModel),p=s.documentModel._state.nodes[t].data.semanticParameterConfiguration;Object.keys(i).forEach(u=>{const f=i[u].value,h=JSON.stringify(i[u]),m=JSON.stringify(p[u]);if(h!==m&&f!=="disabled"){const g=c[u];g&&g.conflictingSemanticKeys&&g.conflictingSemanticKeys.forEach(b=>{i[b]&&(i[b].value="disabled")})}})}return super.update(t,e,s,a,n)}}class ns extends nt{static update(t,e,s,a=!0){let n=a;if(typeof e.width=="number"){n=!1;const{width:i,children:r}=s.documentModel._state.nodes[t],d=e.width/i,c=[d,0,0,d,0,0];r.forEach(l=>s.applyTransformMatrix(l,c,!0))}return s.documentModel.updateNode(t,e,n)}}const is="combine",os=["A","B"],rs=["array"];function ds({A:o,B:t}){return o=Array.isArray(o)?o:[o],t=Array.isArray(t)?t:[t],{array:[...o,...t]}}k({type:is,inputs:os,outputs:rs,callback:ds});const cs="get-value",ls=["object","key"],hs=["value"];function us({object:o,key:t}){let e=o[t];return typeof e=="object"&&(e=JSON.parse(JSON.stringify(e))),{value:e}}k({type:cs,inputs:ls,outputs:hs,callback:us});const ps="set-value",fs=["object","key","value"],ys=["object"];function ms({object:o,key:t,value:e}){const s=JSON.parse(JSON.stringify(o));return s[t]=typeof e=="object"?JSON.parse(JSON.stringify(e)):e,{object:s}}k({type:ps,inputs:fs,outputs:ys,callback:ms});const gs="crop-image-to-aspect-ratio",bs=["image","aspect"],Ss=["image"],it=document.createElement("canvas"),ct=it.getContext("2d");async function Bt({image:o,aspect:t}){return new Promise(function(e,s){var a=new Image;a.crossOrigin="anonymous",a.onload=function(){if(ct){const n=o.width/o.height,i=t;let r=o.width,d=o.height,c=0,l=0;n>i?(r=i*d,c=(o.width-r)/2):(d=r/i,l=(o.height-d)/2),it.width=r,it.height=d,ct.clearRect(0,0,r,d),ct.drawImage(a,-c,-l,o.width,o.height);const y=it.toDataURL("image/png");e({image:{src:y,width:r,height:d}})}},a.src=o.src})}k({type:gs,inputs:bs,outputs:Ss,callback:Bt});const _s="replace-image",Ns=["imageDisplayNode","image"],Is=["imageDisplayNode"];function ws(o,t,e){var a;let s=!1;if(t)for(const[n,i]of Object.entries(t)){let r=i.value;if(typeof r=="string"&&(e==null?void 0:e.data[r])&&(r=e==null?void 0:e.data[r].value),typeof r=="object"&&r.src===o){const d=e==null?void 0:e.inputs.find(c=>c.id===n);d&&(!d.options||((a=d.options)==null?void 0:a.length)<=1)&&(s=!0)}}return s}async function vs({imageDisplayNode:o,image:t},e,s,a,n,i){let r=t;ws(t.src,i,a)&&(r=(await Bt({image:t,aspect:o.width/o.height})).image);const c=JSON.parse(JSON.stringify(o)),l=c.width*c.height,p=r.width/r.height,y=Math.sqrt(l/p),u=p*y,f=c.x+c.width/2,h=c.y+c.height/2,m=f-u/2,g=h-y/2;return c.x=m,c.y=g,c.width=u,c.height=y,c.data.src=r.src,c.data.aspectRatio=r.width/r.height,c.data.nativeWidth=r.width,c.data.nativeHeight=r.height,{imageDisplayNode:c}}k({type:_s,inputs:Ns,outputs:Is,callback:vs});const xs="set-placement",Ms=["displayNode","placement"],Os=["displayNode"];function Fs({displayNode:o,placement:t}){const e=JSON.parse(JSON.stringify(o));return e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,e.rotate=t.rotate,{displayNode:e}}k({type:xs,inputs:Ms,outputs:Os,callback:Fs});const Ts="set-value-to-object-data",Ps=["object","key","value"],Es=["object"];function Ds({object:o,key:t,value:e}){const s=JSON.parse(JSON.stringify(o)),a=s.data||{};return a[t]=typeof e=="object"?JSON.parse(JSON.stringify(e)):e,s.data=a,{object:s}}k({type:Ts,inputs:Ps,outputs:Es,callback:Ds});const Cs="get-value-from-object-data",js=["object","key"],ks=["value"];function Rs({object:o,key:t}){let a=((o||{}).data||{})[t];return typeof a=="object"&&(a=JSON.parse(JSON.stringify(a))),{value:a}}k({type:Cs,inputs:js,outputs:ks,callback:Rs});const As="get-substance-filtered-image",Ks=["imageUrl","substanceConfig"],Vs=["filteredImageUrl"],lt=new Map;async function $s({imageUrl:o,substanceConfig:t}){const e=`${o}:${JSON.stringify(t)}`;if(lt.has(e))return{filteredImageUrl:lt.get(e)};const s=await Ot(t.id),a=await Ft(o),n=await Ct(o,a,s,t.params),i=await pt(n);return lt.set(e,i.url),await Tt(i.url),{filteredImageUrl:i.url}}k({type:As,inputs:Ks,outputs:Vs,callback:$s});const Ls="set-value-to-pack-inputs",Bs=["object","key","value"],Js=["object"];function Us({object:o,key:t,value:e}){const s=JSON.parse(JSON.stringify(o));return s.data=s.data||{},s.data.packInputs=s.data.packInputs||{},s.data.packInputs[t]=s.data.packInputs[t]||{},s.data.packInputs[t].value=typeof e=="object"?JSON.parse(JSON.stringify(e)):e,{object:s}}k({type:Ls,inputs:Bs,outputs:Js,callback:Us});const zs="assign-values-to-object-data",Ys=["object","values"],Hs=["object"];function Gs({object:o,values:t}){const e=JSON.parse(JSON.stringify(o)),s=e.data||{},a=JSON.parse(JSON.stringify(t));return Object.assign(s,a),e.data=s,{object:e}}k({type:zs,inputs:Ys,outputs:Hs,callback:Gs});function Ws(o,t,e){const s=e.id,a=Rt(t,e),n=Object.keys(a.nodes),i=[],r={};r[s]={},n.forEach(u=>{const f={},h=a.nodes[u].staticInput||{};for(const[m,g]of Object.entries(h)){let b=g;typeof g=="string"&&e.data[g]&&(b=e.data[g].value),f[m]=Promise.resolve(b)}r[u]=f});let d=!1;if(e.inputs.forEach(u=>{if(u.type==="preset")return;const f=`${s}::${u.id}`,h=a.adjacencyList[f]||[],m=kt(e,u,t);if(!m){console.warn("Missing required input parameter for graph",u.id);return}let{type:g,value:b}=m;g==="template"&&(d=!0,b=JSON.parse(JSON.stringify(b))),h.forEach(I=>{const[S,w]=I.split("::");r[S][w]=Promise.resolve(b)})}),d===!1){const u=e.defaultGraphId,h=e.data[u].value,m=`${s}::${X}`,g=a.adjacencyList[m]||[],b=JSON.parse(JSON.stringify(h));g.forEach(I=>{const[S,w]=I.split("::");r[S][w]=Promise.resolve(b)})}for(n.forEach(u=>{const f=a.nodes[u].type;vt(f,r[u])&&i.push(u)});i.length>0;){const u=i.pop(),h=a.nodes[u].type,m=Ze(h),g=r[u],b=m(g,u,a,e,r,t),I=ts(u,b,r,a);for(let S=I.length-1;S>=0;S-=1){const w=I[S];if(w===s)continue;const N=a.nodes[w].type;vt(N,r[w])&&i.push(w)}}const c=r[s],l=c[be],p=c[Se];!l&&!p&&console.warn("Executing graph did not yield a result. Ensure effect is properly structured.");const y=[];return l&&y.push(l),p&&y.push(p),Promise.resolve(y)}class bt extends nt{static get defaultData(){return{name:"",backgroundColor:"#FFFFFF",scale:1,hasRendered:!1,packInputs:{},packConfig:{}}}static create(t,e,s){return t.data=t.data||{},super.create(t,e,s)}static update(t,e,s,a,n){var E,U,A,z;const i=s.documentModel._state.nodes[t],r=(E=e.data)==null?void 0:E.packInputs,d=(U=e.data)==null?void 0:U.packConfig,c=typeof r!="undefined",l=typeof d!="undefined",p=((A=e.data)==null?void 0:A.scale)&&((z=e.data)==null?void 0:z.scale)!==i.data.scale,y=(e.width||e.height)&&e.width!==i.width&&e.height!==i.height;let u=r||i.data.packInputs;const f=d||i.data.packConfig;if(!i.data.hasRendered&&!d)return s.documentModel;const h=c||l;if(h){const v=r||{},D=(i.data.packInputs||{})[L],T=u[L],K=D==null?void 0:D.value,V=T==null?void 0:T.value;if(V&&K!==V){const R=f.data[V];if(R&&R.value){for(const[Y,Z]of Object.entries(R.value))v[Y]={type:"packDataKey",value:Z};u=v,e.data.packInputs=v}}}const{width:m,height:g}=At(u,f),b=m,I=i.width,S=I/b;let N=(e.width||I)/b;if(i.data.hasRendered?y?(e.data=e.data||{},e.data.scale=N):p&&(e.width=m*N,e.height=g*N):(N=1,e.data=e.data||{},e.data.scale=1,e.data.hasRendered=!0,e.width=m,e.height=g),h)f.graphs&&(s.addPendingMutation(),Ws(t,u,f).then(v=>{const F=Array.isArray(v)?v:[Promise.resolve(v)];F.forEach(D=>{D.then(T=>{const K={},V=[];for(const[O,M]of Object.entries(T)){const tt=`${t}-${O}`;M.parentId?M.parentId=`${t}-${M.parentId}`:(V.push(tt),M.parentId=t),M.children&&(M.children=M.children.map(Ut=>`${t}-${Ut}`)),K[tt]=M}const R=s.documentModel.listOfNodeIdsInSubtree_PACK_STOP(t),Y=[...V];for(;Y.length;){const O=Y.shift(),M=K[O];M.type!=="pack"&&M.children&&Y.push(...M.children),s.documentModel.hasNode(O)?s.documentModel.updateNode(O,M,!1):s.documentModel.createNode(M,O),M.type==="text"&&s.conformTextNode(O),M.type==="pack"&&bt.update(O,M,s);const tt=R.indexOf(O);tt>=0&&R.splice(tt,1)}R.forEach(O=>{s.documentModel.deleteNode(O)});const Z=[N,0,0,N,0,0];V.forEach(O=>s.applyTransformMatrix(O,Z,!0))})}),Promise.all(F).then(()=>s.resolvePendingMutation())}));else if(p||y){const v=N/S,F=[v,0,0,v,0,0];i.children.forEach(D=>s.applyTransformMatrix(D,F,!0))}return a=!1,super.update(t,e,s,a,n)}}class Jt extends J{}class qs extends Jt{static get defaultData(){return{}}}class Xs extends Jt{static get defaultData(){return{color:"#CCCCCC",size:4,alignment:"outer",shape:"rectangle"}}}class Qs extends J{static get defaultData(){return{name:"Variant Set"}}}const Zs={canvas:Fe,artboard:ke,"artboard-group":as,rectangle:Te,text:Pe,image:De,ellipse:Ce,circle:je,container:ns,pack:bt,"effect-graph":qs,"effect-stroke":Xs,"variant-set":Qs};function et(o){return Zs[o]}class ta{constructor(){this.currentDocumentStateVersionTag="",this.displayedContentNodes=[],this.displayGraphModel=new at}get staticDisplayGraphState(){return JSON.parse(JSON.stringify(this.displayGraphModel.state))}generateDisplayGraphFromStringifiedState(t,e=0){this.displayedContentNodes=[],this.displayGraphModel.setStringifiedState(t);const s=[[this.displayGraphModel.state.rootNodeId,_.defaultMatrix]],a=[],n=[];for(;s.length;){const i=s.pop(),r=i[0],d=i[1],c=this.displayGraphModel.state.nodes[r],{type:l,parentId:p,blendMode:y,children:u,x:f,y:h,rotate:m,width:g,height:b,effects:I}=c;l==="artboard"?n.unshift(r):l!=="container"&&l!=="canvas"&&a.unshift(r);const S=_.compose(f,h,m),w=p?this.displayGraphModel.indexOfChildWithinParent(r,p):0;c.globalTransform=_.multiply([],d,S),c.index=w,c.dataCacheKey=`${JSON.stringify(c.data)}:${c.blendMode}`,c.placementCacheKey=S.join(":"),c.sizeCacheKey=`${c.width}:${c.height}`;for(let N=0;N<u.length;N+=1)s.push([u[N],c.globalTransform])}return this.displayedContentNodes=[this.displayGraphModel.rootNodeId,...n,...a],this.displayGraphModel.state}generateDisplayGraphFromDocumentModel(t,e=0){return this.currentDocumentStateVersionTag===t.state.versionTag?this.displayGraphModel.state:(this.currentDocumentStateVersionTag=`${t.state.versionTag}:${e}`,this.generateDisplayGraphFromStringifiedState(t.stringify(),e))}}const ea=6;function G(o,t){const e=t.nodes[o],{parentId:s,x:a,y:n,rotate:i}=e,r=_.compose(a,n,i);let d=t.nodes[s];for(;d;){const{parentId:c,x:l,y:p,rotate:y}=d,u=_.compose(l,p,y);_.multiply(r,u,r),d=t.nodes[c]}return r}class ra{constructor(t,e,s=()=>{},a=()=>{}){this.isNodeUnderMutation=!1,this.pendingMutationsCount=0,this.pendingMutationCallbacks=[],this.renderCallback=s,this.selectionCallback=a,this.undoHistory=new Qt,this.documentModel=t,this.displayGraphController=new ta,this.editorModel=e,this.validateInitialModelState(),this.registerNewUndoableDocumentState=Zt(this._registerNewUndoableDocumentState.bind(this),150),this.handleNewDocumentState(),this.trackedGestures=new Map}validateInitialModelState(){this.documentModel.forEachNode(t=>{const s=et(t.type).defaultData;Object.assign(s,t.data),this.documentModel.updateNode(t.id,{data:s})})}addPendingMutation(){this.pendingMutationsCount++}resolvePendingMutation(){this.pendingMutationsCount=Math.max(0,this.pendingMutationsCount-1),this.pendingMutationsCount===0&&(this.pendingMutationCallbacks.forEach(t=>t("")),this.pendingMutationCallbacks=[])}handleNewDocumentState(){this.registerNewUndoableDocumentState(this.documentModel.stringify()),this.editorModel.setIsDirty(!0)}generateDisplayGraph(){return this.displayGraphController.generateDisplayGraphFromDocumentModel(this.documentModel,this.editorModel._state.timelinePosition)}async setPackFileInput(t,e,s){const{data:{packInputs:a={}}}=this.documentModel.getNode(e),n=await pt(t),i=JSON.parse(JSON.stringify(a));i[s]={value:{src:n.url,width:n.width,height:n.height}},this.update(e,{data:{packInputs:i}}),this.pendingMutationsCount>0&&await new Promise(r=>this.pendingMutationCallbacks.push(r))}generateVariantDisplayGraphs(){const t=this.documentModel.stringify(),e=[],a=this.documentModel.findAll(c=>c.type==="variant-set").map(c=>this.documentModel._state.nodes[c].items),n=a.map(c=>c.length),i=Math.max(...n),r=Math.min(ea,i);let d=0;for(let c=0;c<r;c++){for(let l=0;l<a.length;l++){const p=a[l],y=p.length;let u=c;c>y-1&&(u+=d+l);let f=u%y;const h=p[f];this.documentModel.activateVariant(h)}e.push(this.generateDisplayGraph()),d+=1}return this.documentModel.setStringifiedState(t),e}semanticInferenceForScope(t){const e=Lt(t,this.documentModel),{data:{semanticParameterConfiguration:s={}}}=this.documentModel.getNode(t),a={};for(const[n,i]of Object.entries(e)){let d={label:"",value:n==="Preset"?"select-state":"disabled",valueLabels:{}};s.hasOwnProperty(n)&&(d=s[n]),a[n]=d}return this.update(t,{data:{semanticParameterConfiguration:a}}),e}handleNodeUnderMutation(){this.isNodeUnderMutation=!0,this.editorModel.setIsNodeUnderMutation(!0),this.mutationTimeout&&clearTimeout(this.mutationTimeout),this.mutationTimeout=setTimeout(()=>{this.editorModel.setIsNodeUnderMutation(!1),this.renderCallback()},400)}_registerNewUndoableDocumentState(t){this.undoHistory.save(t),this.editorModel.setCanRedo(this.undoHistory.canRedo),this.editorModel.setCanUndo(this.undoHistory.canUndo),this.renderCallback()}undo(){const t=this.undoHistory.undo();this.editorModel.setCanRedo(this.undoHistory.canRedo),this.editorModel.setCanUndo(this.undoHistory.canUndo),this.selectionCallback(),this.documentModel.setStringifiedState(t),this.renderCallback()}redo(){const t=this.undoHistory.redo();this.editorModel.setCanRedo(this.undoHistory.canRedo),this.editorModel.setCanUndo(this.undoHistory.canUndo),this.selectionCallback(),this.documentModel.setStringifiedState(t),this.renderCallback()}async save(){return this.documentModel.saveToStorageService().then(()=>{window.history.replaceState(null,"",`?id=${this.documentModel._state.id}`),this.editorModel.setIsSaved(!0),this.editorModel.setIsDirty(!1),this.renderCallback()})}duplicate(){return this.documentModel.duplicateToStorageService().then(()=>{window.history.replaceState(null,"",`?id=${this.documentModel._state.id}`),this.editorModel.setIsSaved(!0),this.editorModel.setIsDirty(!1),this.renderCallback()})}handleBoundsAdjustStart(t,{gestureId:e}){if(this.editorModel._state.isPanningMode){this.editorModel.setIsPanning(!0),this.renderCallback();return}this.trackedGestures.set(e,{docStateAtStart:this.documentModel.state,displayGraphAtStart:this.displayGraphController.staticDisplayGraphState}),this.editorModel.addDragging(t)}getGlobalPlacementForNode(t){const e=G(t,this.documentModel._state),{position:{x:s,y:a},rotation:n}=_.decompose(e);return{x:s,y:a,rotation:n}}getGlobalBoundsPointsForNode(t){const{width:e,height:s}=this.documentModel._state.nodes[t],a=G(t,this.documentModel._state);return[_.transformPoint(0,0,a),_.transformPoint(e,0,a),_.transformPoint(e,s,a),_.transformPoint(0,s,a)]}conformChildrenArtboardIntersections(){const t=[],e=[],{rootNodeId:s,nodes:a}=this.documentModel._state,{children:n}=a[s],i=new Map;n.forEach(r=>{const d=this.documentModel.getNodeType(r);if(d==="artboard-group"){const c=a[r];e.push(...c.children)}else d==="artboard"?e.push(r):(t.push(r),i.set(r,this.getGlobalBoundsPointsForNode(r)))}),e.forEach(r=>{const d=a[r];i.set(r,this.getGlobalBoundsPointsForNode(r)),d.children.forEach(c=>{t.push(c),i.set(c,this.getGlobalBoundsPointsForNode(c))})}),t.forEach(r=>{const d=i.get(r),c=this.documentModel.getNodeParentId(r),l=i.get(c);if(l){if(x.doRectanglesIntersect(d,l))return;this.update(r,{parentId:this.documentModel._state.rootNodeId})}e.forEach(p=>{if(c===p)return;const y=i.get(p);x.doRectanglesIntersect(d,y)&&this.update(r,{parentId:p})})})}conformContainerBoundsToChildren(...t){const e=[];t.forEach(s=>{const a=this.documentModel._state.nodes[s],{parentId:n,type:i,children:r,x:d,y:c,rotate:l}=a;if(n&&e.indexOf(n)&&e.push(n),r.length===0||i==="canvas"||i==="artboard")return;const p=[];r.forEach(h=>{const m=this.documentModel._state.nodes[h];if(!m.variantSetId)return;const g=this.documentModel._state.nodes[m.variantSetId];for(let b=0;b<g.items.length;b++){const I=g.items[b];I!==h&&p.push(I)}});const y=[...r,...p],u=this.unrotatedLocalBounds(...y),f=x.rotatePoint(u,l);this.documentModel.updateNode(s,{x:d+f.x,y:c+f.y,width:u.width,height:u.height}),y.forEach(h=>{const m=this.documentModel._state.nodes[h];this.documentModel.updateNode(h,{x:m.x-u.x,y:m.y-u.y})})}),e.length>0&&this.conformContainerBoundsToChildren(...e)}conformTextNode(t){const e=this.documentModel._state.nodes[t],{x:s,y:a,width:n,height:i}=Pt(e.x,e.y,e.width,e.height,e.rotate,e.data.alignment,e.data.size,e.data.text,e.data.font,e.data.weight,e.data.style,e.data.letterSpacing);this.documentModel.updateNode(t,{x:s,y:a,width:n,height:i},!1)}applyTransformMatrix(t,e,s=!1){const a={},n=this.documentModel._state.nodes[t],i=_.compose(n.x,n.y,n.rotate),r=_.multiply([],i,e),{scale:d,rotation:c}=_.decompose(r);a.x=n.x*d.x,a.y=n.y*d.y,a.rotate=c,a.width=n.width*d.x,a.height=n.height*d.y,n.type==="text"&&(a.data={size:n.data.size*d.x,letterSpacing:n.data.letterSpacing*d.x});const l=!1;this.update(t,a,s,l)}handleBoundsAdjust(t,e,s){const{gestureId:a,deltaX:n,deltaY:i}=e,r=this.trackedGestures.get(a);if(this.editorModel._state.isPanning){this.editorModel.setOriginOffsetX(this.editorModel._state.originOffsetX+n),this.editorModel.setOriginOffsetY(this.editorModel._state.originOffsetY+i),this.renderCallback();return}this.editorModel._state.selections.forEach(d=>{const c=this.documentModel.getNodeType(d);if(r){const{docStateAtStart:l,displayGraphAtStart:p}=r,y=et(c),u=y.convertRawGestureToNodeRelativeTotalDeltaVector(s,d,e,l,this);y.adjustBounds(s,d,u,e,l,p,this)}}),this.renderCallback()}applyEffectGraphEdges(t,e){const{data:{graph:s}}=this.documentModel._state.nodes[t],a={};e.edges.forEach(n=>{const i=`${n.outNodeId}:output:${n.outPortId}`,r=`${n.inNodeId}:input:${n.inPortId}`;a[i]||(a[i]=[]),a[i].push(r)}),s.adjacencyList=a,this.documentModel.updateNode(t,{data:{graph:s}})}applyEffectGraphArrangement(t,e){const{data:{graph:s}}=this.documentModel._state.nodes[t];Object.keys(e).forEach(a=>{const n=e[a],i=s.nodes[a];i.x=Math.round(n.x),i.y=Math.round(n.y)}),this.documentModel.updateNode(t,{data:{graph:s}})}handleBoundsAdjustEnd(t,{gestureId:e}){if(this.editorModel._state.isPanning===!0){this.editorModel.setIsPanning(!1),this.renderCallback();return}const s=[];this.editorModel._state.selections.forEach(a=>{const n=this.documentModel.getNodeParentId(a),i=this.documentModel.getNodeType(n);n&&i!=="canvas"&&s.indexOf(n)===-1&&s.push(n)}),this.conformContainerBoundsToChildren(...s),this.conformChildrenArtboardIntersections(),this.trackedGestures.delete(e),this.editorModel.removeDragging(t),this.editorModel.setSnaplines(),this.editorModel.setSnappoints(),this.handleNewDocumentState()}create(t,e=!1,s){const n=et(t.type).create(t,this,s);return this.conformChildrenArtboardIntersections(),e===!1&&this.handleNewDocumentState(),this.renderCallback(),n}update(t,e,s=!1,a=!0){const n=this.documentModel.getNodeType(t),i=this.documentModel.getNodeParentId(t),r=this.documentModel.getNodeType(i),d=et(n);let c="",l="",p=!0;if(e.parentId&&e.parentId!==i&&(c=e.parentId,l=this.documentModel.getNodeType(c),n==="artboard"&&l!=="artboard-group"&&l!=="canvas"&&(p=!1,delete e.parentId),n!=="artboard"&&l==="artboard-group"&&(p=!1,delete e.parentId),n==="artboard-group"&&l!=="canvas"&&(p=!1,delete e.parentId),p)){const y=G(t,this.documentModel._state),u=G(c,this.documentModel._state),f=_.difference([],u,y),h=_.decompose(f),{x:m,y:g,rotate:b}=e;m===void 0&&(e.x=h.position.x),g===void 0&&(e.y=h.position.y),b===void 0&&(e.rotate=h.rotation)}d.update(t,e,this,a),i&&r!=="canvas"&&s===!1&&this.conformContainerBoundsToChildren(i),c&&p&&l!=="canvas"&&s===!1&&this.conformContainerBoundsToChildren(c),s===!1&&this.handleNewDocumentState(),this.renderCallback()}delete(t,e=!1){const s=this.documentModel.getNodeType(t),a=this.documentModel.getNodeParentId(t);et(s).delete(t,this),this.conformContainerBoundsToChildren(a),this.conformChildrenArtboardIntersections(),e===!1&&this.handleNewDocumentState(),this.renderCallback()}createShape(t){const{originOffsetX:e,originOffsetY:s,renderScale:a,viewportWidth:n,viewportHeight:i}=this.editorModel._state;this.create({parentId:this.documentModel._state.rootNodeId,type:t,x:(-e+n/2)/a,y:(-s+i/2)/a,data:{color:`#${St.color}`,borderSize:1}})}createText(t){const{originOffsetX:e,originOffsetY:s,renderScale:a,viewportWidth:n,viewportHeight:i}=this.editorModel._state,{font:r,weight:d,style:c,fontLabel:l,text:p}=t;this.create({parentId:this.documentModel._state.rootNodeId,type:"text",width:200,height:100,x:(-e+n/2)/a,y:(-s+i/2)/a,data:{text:p,font:r,weight:d,style:c,fontLabel:l,color:`#${St.color}`}})}createImage(t){const{originOffsetX:e,originOffsetY:s,renderScale:a,viewportWidth:n,viewportHeight:i}=this.editorModel._state,{src:r,width:d,height:c}=t;this.create({parentId:this.documentModel._state.rootNodeId,type:"image",width:d,height:c,x:(-e+n/2)/a-d/2,y:(-s+i/2)/a-c/2,data:{aspectRatio:d/c,nativeWidth:d,nativeHeight:c,src:r}})}replaceImage(t,e){const s=this.documentModel._state.nodes[t],{src:a,width:n,height:i}=e,r=s.x+s.width/2,d=s.y+s.height/2,c=s.data.nativeWidth||n,l=s.width/c,p=n*l,y=i*l,u=r-p/2,f=d-y/2;this.update(t,{width:p,height:y,x:u,y:f,data:{aspectRatio:n/i,nativeWidth:n,nativeHeight:i,src:a}})}unrotatedLocalBounds(...t){const e=[],s=[];t.forEach(d=>{const{x:c,y:l,width:p,height:y,rotate:u}=this.documentModel._state.nodes[d],f=_.compose(c,l,u),h=_.transformPoint(0,0,f),m=_.transformPoint(p,0,f),g=_.transformPoint(0,y,f),b=_.transformPoint(p,y,f);e.push(h.x,m.x,g.x,b.x),s.push(h.y,m.y,g.y,b.y)});const a=Math.min(...e),n=Math.max(...e),i=Math.min(...s),r=Math.max(...s);return{x:a,y:i,width:n-a,height:r-i}}duplicateIdFromDocumentState(t,e){const s=e.nodes[t];if(!s)return"";const{selections:a}=this.editorModel._state,n=a.map(h=>this.documentModel.getNodeParentId(h)),i=[...new Set(n)],r=i.length===1?i[0]:this.documentModel._state.rootNodeId,d=G(t,e),c=G(r,this.documentModel.state),l=_.difference([],c,d),p=_.decompose(l);s.x=p.position.x,s.y=p.position.y,s.rotate=p.rotation,s.parentId=r;const y=this.documentModel.createNode({parentId:s.parentId,type:s.type,isEffect:s.isEffect,isEffectNode:s.isEffectNode,data:s.data,blendMode:s.blendMode,x:s.x,y:s.y,width:s.width,height:s.height,rotate:s.rotate}),u=[...s.children],f={};for(f[t]=y;u.length;){const h=u.shift(),m=e.nodes[h],g=this.documentModel.createNode({parentId:f[m.parentId],type:m.type,isEffect:m.isEffect,isEffectNode:m.isEffectNode,data:m.data,blendMode:m.blendMode,x:m.x,y:m.y,width:m.width,height:m.height,rotate:m.rotate});f[h]=g,u.push(...m.children)}return y}duplicateIdsFromDocumentState(t,e){const s=t.map(i=>this.duplicateIdFromDocumentState(i,e)),a=s.map(i=>this.documentModel.getNodeParentId(i)),n=[...new Set(a)];return this.conformContainerBoundsToChildren(...n),s}ungroupSelections(){const{selections:t}=this.editorModel._state;t.length!==0&&([...t].forEach(e=>{const{type:s,parentId:a,children:n,x:i,y:r,rotate:d}=this.documentModel.getNode(e);if(s!=="container")return;const c=this.indexWithinParent(e),l=_.compose(i,r,d);n.reverse().forEach(p=>{const y=this.documentModel.getNode(p),u=_.compose(y.x,y.y,y.rotate),f=_.multiply([],l,u),h=_.decompose(f);if(this.documentModel.updateNode(p,{parentId:a,index:c,x:h.position.x,y:h.position.y,rotate:h.rotation}),y.variantSetId){const m=this.documentModel.getNode(y.variantSetId),{items:g}=m;for(let b=0;b<g.length;b++){const I=g[b];if(I===p)continue;const S=this.documentModel.getNode(g[b]),w=_.compose(S.x,S.y,S.rotate),N=_.multiply([],l,w),E=_.decompose(N);this.documentModel.updateNode(I,{x:E.position.x,y:E.position.y,rotate:E.rotation})}}}),this.editorModel.removeAllStateForId(e),this.documentModel.deleteNode(e)}),this.handleNewDocumentState(),this.renderCallback())}maskSelections(t){this.groupSelections()}groupSelections(){const{selections:t}=this.editorModel._state;if(t.length===0)return;let e=!1,s=!1,a=!1;const n=[];if(t.forEach(u=>{const f=this.documentModel.getNode(u),{type:h,parentId:m,variantSetId:g}=f;if(m!==this.documentModel._state.rootNodeId&&(a=!0),h==="artboard"?e=!0:(s=!0,this.documentModel.traverseSubtreeOfNode(u,b=>{b.type==="artboard"&&(s=!0)})),g){const b=this.documentModel.getNode(g),{items:I}=b;for(let S=0;S<I.length;S++)I[S]!==u&&n.push(I[S])}}),e&&s){alert("artboards cannot be grouped with non-artboards");return}if(e&&a){alert("artboards must be at root to be grouped");return}const r=t[0],d=this.documentModel._state.nodes[r].parentId,c=this.unrotatedLocalBounds(...t,...n),l=e?"artboard-group":"container",p=this.create({parentId:d,type:l,x:c.x,y:c.y,width:c.width,height:c.height});t.sort((u,f)=>{const h=this.indexWithinParent(u),m=this.indexWithinParent(f);return h===m?0:h>m?1:-1}).forEach(u=>{const{x:f,y:h}=this.documentModel._state.nodes[u];this.documentModel.updateNode(u,{parentId:p,x:f-c.x,y:h-c.y})}),n.forEach(u=>{const{x:f,y:h}=this.documentModel._state.nodes[u];this.documentModel.updateNode(u,{x:f-c.x,y:h-c.y})}),this.conformChildrenArtboardIntersections(),l!=="artboard-group"&&this.selectionCallback(p),this.handleNewDocumentState(),this.renderCallback()}addVariant(t){let s=this.documentModel._state.nodes[t].variantSetId;s||(s=this.create({type:"variant-set"}),this.documentModel.addNodeIdToVariantSet(s,t));const a=this.documentModel.duplicateNode(t);this.selectionCallback(a),this.documentModel.addNodeIdToVariantSet(s,a),this.documentModel.updateNode(t,{parentId:""}),this.handleNewDocumentState(),this.renderCallback()}deleteVariant(t,e){const a=this.documentModel._state.nodes[t].variantSetId,n=e.id;this.editorModel.removeAllStateForId(n);const i=this.documentModel.deleteVariant(a,n);i&&this.editorModel.addSelection(i),this.handleNewDocumentState(),this.renderCallback()}selectVariant(t,e){this.editorModel.removeAllStateForId(t),this.documentModel.swapActiveVariant(t,e),e&&this.editorModel.addSelection(e),this.handleNewDocumentState(),this.renderCallback()}makeVariantSetFromSelections(){let t="";const{selections:e}=this.editorModel._state,s=e[0];for(let n=0;n<e.length;n+=1){const i=e[n],{variantSetId:r}=this.documentModel._state.nodes[i];if(r){t=r;break}}t||(t=this.create({type:"variant-set"})),[...e].forEach(n=>{const{variantSetId:i}=this.documentModel._state.nodes[n];if(t!==i)if(i){const{items:r}=this.documentModel._state.nodes[i];[...r].forEach(d=>{this.documentModel.removeItemFromVariantSet(i,d),this.documentModel.addNodeIdToVariantSet(t,d)})}else this.documentModel.addNodeIdToVariantSet(t,n)});const{items:a}=this.documentModel._state.nodes[t];a.forEach(n=>{n!==s&&this.documentModel.updateNode(n,{parentId:""})}),this.selectionCallback(s),this.handleNewDocumentState(),this.renderCallback()}indexWithinParent(t){const e=this.documentModel._state.nodes[t];return this.documentModel._state.nodes[e.parentId].children.indexOf(t)}adjustLayerOrder(t,e){const s=this.indexWithinParent(t);this.documentModel.updateNode(t,{index:s+e}),this.handleNewDocumentState(),this.renderCallback()}async addCargoPack(t){const e=await Yt(t),{rootNodeId:s}=this.documentModel._state,{width:a,height:n}=At({},e),i=this.create({type:"pack",width:a,height:n,parentId:s});return this.update(i,{data:{packInputs:{},packConfig:e}}),i}delegateEvent(t){const e=t.action||"none",s={};switch(e){case"undo":this.undo();break;case"redo":this.redo();break;case"save":this.save();break;case"duplicate":this.duplicate();break;case"conform-artboard-intersections":this.conformChildrenArtboardIntersections();break;case"mask-selections":if(!t.id)return;this.maskSelections(t.id);break;case"group-selections":this.groupSelections();break;case"ungroup-selections":this.ungroupSelections();break;case"select-variant":if(!t.id||!t.value)return;this.selectVariant(t.id,t.value);break;case"replace-image":if(!t.id||!t.data)return;this.replaceImage(t.id,t.data);break;case"add-variant":if(!t.id)return;this.addVariant(t.id);break;case"delete-variant":if(!t.id||!t.data)return;this.deleteVariant(t.id,t.data);break;case"make-variant-set-from-selections":this.makeVariantSetFromSelections();break;case"set-thumbnail":this.documentModel.setThumbnail(t.data),this.handleNewDocumentState();break;case"set-extra-thumbnails":this.documentModel.setExtraThumbnails(...t.data),this.handleNewDocumentState();break;case"set-tags":this.documentModel.setTags(...t.data),this.handleNewDocumentState();break;case"set-author":this.documentModel.setAuthor(t.data),this.handleNewDocumentState();break;case"set-tool":this.documentModel.setTool(t.data),this.handleNewDocumentState();break;case"set-name":this.documentModel.setName(t.data),this.handleNewDocumentState();break;case"set-color":if(!t.id)return;this.handleNodeUnderMutation(),this.update(t.id,{data:{color:t.color}});break;case"set-text":if(!t.id)return;this.handleNodeUnderMutation(),this.update(t.id,{data:{text:t.value}});break;case"update-node":if(!t.id)return;this.handleNodeUnderMutation(),this.update(t.id,t.nodeData);break;case"set-size":if(!t.id)return;this.handleNodeUnderMutation(),this.update(t.id,{data:{size:t.value}});break;case"set-letterspacing":if(!t.id)return;this.handleNodeUnderMutation(),this.update(t.id,{data:{letterSpacing:t.value}});break;case"adjust-layer-order":if(!t.id||typeof t.value=="undefined")return;this.handleNodeUnderMutation(),this.adjustLayerOrder(t.id,t.value);break;case"set-properties":if(!t.id||typeof t.data=="undefined")return;this.handleNodeUnderMutation(),s.data=t.data,this.update(t.id,s);break;case"set-property":if(!t.id||typeof t.key=="undefined"||typeof t.value=="undefined")return;this.handleNodeUnderMutation(),s.data={},s.data[t.key]=t.value,this.update(t.id,s);break;case"add-artboard":this.create({type:"artboard",index:0,width:t.width,height:t.height,data:t.data});break;case"add-shape":if(!t.value)return;this.createShape(t.value);break;case"add-text":if(!t.data)return;this.createText(t.data);break;case"add-image":if(!t.data)return;this.createImage(t.data);break;case"bounds-adjust-start":if(!t.data||!t.id)return;if(t.originalEvent&&t.originalEvent.detail.altKey===!0&&t.subject==="translate"){const a=this.duplicateIdsFromDocumentState(this.editorModel._state.selections,this.documentModel.state);this.selectionCallback(...a)}this.handleBoundsAdjustStart(t.id,t.data);break;case"bounds-adjust-end":if(!t.data||!t.id)return;this.handleBoundsAdjustEnd(t.id,t.data);break;case"bounds-adjust":if(!t.data||!t.id||!t.subject)return;this.handleBoundsAdjust(t.id,t.data,t.subject);break;case"load-file-state-from-json":if(!t.data)return;if(!t.data.id||!t.data.versionTag||!t.data.nodes||!t.data.rootNodeId){console.info("Invalid document json loaded",t.data);return}this.documentModel.setStringifiedState(JSON.stringify(t.data)),this.validateInitialModelState(),this.handleNewDocumentState(),this.renderCallback();break;case"add-cargo-pack":if(!t.id)return;this.addCargoPack(t.id);break;case"set-pack-file-input":if(!t.value||!t.key||!t.id)return;this.setPackFileInput(t.value,t.id,t.key);break}}}const q=document.createElement("canvas"),W=q.getContext("2d"),xt=8e3;class da{constructor(){this.renderer=new ge({antialias:!0,resolution:1,preserveDrawingBuffer:!0,clearBeforeRender:!0,backgroundAlpha:0})}get canvas(){return this.renderer.canvas}async getRendition({displayGraph:t,rootId:e,scale:s=1}){const{x:a,y:n,width:i,height:r}=t.nodes[e];let d=s*1;this.renderer.displayGraph=t,this.renderer.rootId=e;const c=d*i,l=d*r,p=Math.min(xt/c,xt/l);return p<1&&(d*=p),this.renderer.origin={x:-a*d,y:-n*d},this.renderer.canvasSize={width:Math.round(i*d),height:Math.round(r*d)},this.renderer.scale=d,await this.renderer.render(),W==null||W.clearRect(0,0,q.width,q.height),q.width=Math.round(i*s),q.height=Math.round(r*s),new Promise((y,u)=>{setTimeout(()=>{W==null||W.drawImage(this.renderer.canvas,0,0,Math.round(i*s),Math.round(r*s)),y(q.toDataURL())},20)})}}class ca{constructor(){this._state={debug:!1,renderScale:.3,isPanningMode:!1,isPanning:!1,isSaved:!1,isDirty:!1,isNodeUnderMutation:!1,canUndo:!1,canRedo:!1,originOffsetX:0,originOffsetY:0,viewportWidth:500,viewportHeight:500,targetLayersPanelHeight:300,showAssetsPanel:!1,activeToolbarSection:"discover",selections:[],loading:[],interactable:[],selectableHovers:[],hovers:[],dragging:[],resizing:[],snaplines:[],snappoints:[],messages:[],timelinePosition:0,isLayersPaletteOpen:!1,semanticInferenceData:{}},this._stringifiedState=""}_removeFromList(t,e){const s=t.indexOf(e);return s>-1&&t.splice(s,1),this.dirtyState(),this}_addToList(t,e){return t.indexOf(e)===-1&&(t.push(e),this.dirtyState()),this}dirtyState(){this._stringifiedState=""}clearSelections(){this._state.selections=[],this.dirtyState()}clearHovers(){this._state.hovers=[],this.dirtyState()}clearDragging(){this._state.dragging=[],this.dirtyState()}clearResizing(){this._state.resizing=[],this.dirtyState()}clearInteractable(){this._state.interactable=[],this.dirtyState()}isSelected(t){return this._state.selections.indexOf(t)>=0}isLoading(t){return this._state.loading.indexOf(t)>=0}isHovered(t){return this._state.hovers.indexOf(t)>=0}isDragging(t){return this._state.dragging.indexOf(t)>=0}isResizing(t){return this._state.resizing.indexOf(t)>=0}isNotSelected(t){return!this.isSelected(t)}isNotHovered(t){return!this.isHovered(t)}isNotDragging(t){return!this.isDragging(t)}isNotResizing(t){return!this.isResizing(t)}setActiveToolbarSection(t){return this._state.activeToolbarSection=t,this.dirtyState(),this}setDebug(t){return this._state.debug=t,this.dirtyState(),this}setSemanticInferenceData(t={}){return this._state.semanticInferenceData=t,this.dirtyState(),this}setTargetLayersPanelHeight(t){return this._state.targetLayersPanelHeight=t,this.dirtyState(),this}setShowAssetsPanel(t){return this._state.showAssetsPanel=t,this.dirtyState(),this}setCanUndo(t){return this._state.canUndo=t,this.dirtyState(),this}setCanRedo(t){return this._state.canRedo=t,this.dirtyState(),this}setRenderScale(t){return this._state.renderScale=t,this.dirtyState(),this}setIsPanningMode(t){return this._state.isPanningMode=t,this.dirtyState(),this}setIsPanning(t){return this._state.isPanning=t,this.dirtyState(),this}setIsSaved(t){return this._state.isSaved=t,this.dirtyState(),this}setIsDirty(t){return this._state.isDirty=t,this.dirtyState(),this}setIsLayersPaletteOpen(t){return this._state.isLayersPaletteOpen=t,this.dirtyState(),this}setIsNodeUnderMutation(t){return this._state.isNodeUnderMutation=t,this.dirtyState(),this}setOriginOffsetX(t){return this._state.originOffsetX=t,this.dirtyState(),this}setOriginOffsetY(t){return this._state.originOffsetY=t,this.dirtyState(),this}setViewportWidth(t){return this._state.viewportWidth=t,this.dirtyState(),this}setViewportHeight(t){return this._state.viewportHeight=t,this.dirtyState(),this}setHover(...t){return this._state.hovers=t,this.dirtyState(),this}setSelection(...t){return this._state.selections=t,this.dirtyState(),this}setLoading(...t){return this._state.loading=t,this.dirtyState(),this}setDragging(...t){return this._state.dragging=t,this.dirtyState(),this}setResizing(...t){return this._state.resizing=t,this.dirtyState(),this}setInteractable(...t){return this._state.interactable=t,this.dirtyState(),this}setSelectableHovers(...t){return this._state.selectableHovers=t,this.dirtyState(),this}setSnaplines(...t){return this._state.snaplines=t,this.dirtyState(),this}setSnappoints(...t){return this._state.snappoints=t,this.dirtyState(),this}setTimelinePosition(t){return this._state.timelinePosition=t,this.dirtyState(),this}addHover(t){return this._addToList(this._state.hovers,t)}addLoading(t){return this._addToList(this._state.loading,t)}addInteractable(t){return this._addToList(this._state.interactable,t)}addSelectableHovers(t){return this._addToList(this._state.selectableHovers,t)}addSelection(t){return this._addToList(this._state.selections,t)}addDragging(t){return this._addToList(this._state.dragging,t)}addResizing(t){return this._addToList(this._state.resizing,t)}addMessage(t){const e=$();return t.id=e,this._state.messages.push(t),this.dirtyState(),e}removeMessage(t){let e=-1;this._state.messages.forEach((s,a)=>{s.id===t&&(e=a)}),e>=0&&(this._state.messages.splice(e,1),this.dirtyState())}removeHover(t){return this._removeFromList(this._state.hovers,t)}removeLoading(t){return this._removeFromList(this._state.loading,t)}removeInteractable(t){return this._removeFromList(this._state.interactable,t)}removeselectableHovers(t){return this._removeFromList(this._state.selectableHovers,t)}removeSelection(t){return this._removeFromList(this._state.selections,t)}removeDragging(t){return this._removeFromList(this._state.dragging,t)}removeResizing(t){return this._removeFromList(this._state.resizing,t)}removeAllStateForId(t){this.removeResizing(t),this.removeDragging(t),this.removeLoading(t),this.removeSelection(t),this.removeHover(t),this.removeInteractable(t),this.removeselectableHovers(t)}get hoverCount(){return this._state.hovers.length}get selectionCount(){return this._state.selections.length}get loadingCount(){return this._state.selections.length}get draggingCount(){return this._state.dragging.length}get resizingCount(){return this._state.resizing.length}get interactableCount(){return this._state.resizing.length}get stringifiedState(){return this._stringifiedState||(this._stringifiedState=JSON.stringify(this._state)),this._stringifiedState}get state(){return JSON.parse(this.stringifiedState)}}export{ut as D,ca as E,_ as M,be as O,ge as R,X as S,Zt as a,xe as b,ra as c,oa as d,Se as e,L as f,ve as g,da as h,Xe as i,Qe as j,na as r,ia as t};
