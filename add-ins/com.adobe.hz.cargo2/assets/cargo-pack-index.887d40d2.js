import{a as o,p as n,r as h,e as u}from"./cargo-document-index.5bedc9f1.js";const c="SUBSTANCE_EFFECT_INDEX";class r{constructor(t=()=>{}){this._state={versionUID:"",items:{}},this.stringifiedState="",this.ready=!1,this.onReadyCallback=t,this.hydrateFromStorageService().then(()=>{this.ready=!0,this.onReadyCallback(this.state)})}static getTagsFromSubstanceJson(t){return t.tags||[]}static getAuthorFromSubstanceJson(t){return t.authorName||""}static getNameFromSubstanceJson(t){return t.name||""}static getThumbnailsFromSubstanceJson(t){return[t.thumbnail,...t.presets]}static generateSubstanceMetadataFromSubstanceJson(t){return{thumbnails:r.getThumbnailsFromSubstanceJson(t),author:r.getAuthorFromSubstanceJson(t),name:r.getNameFromSubstanceJson(t),created:Date.now(),modified:Date.now(),tags:r.getTagsFromSubstanceJson(t)}}async hydrateFromStorageService(){const t=await o(c);this._state=t,this.dirtyState()}async saveStateToStorageService(){return await n(this.state,c)}async conflictRobustStateMutationExecution(t){let e=0,a=!1;for(this.ready=!1,await this.hydrateFromStorageService();!a&&e<10;){const s=h();this._state.versionUID=s,t(),this.dirtyState(),await this.saveStateToStorageService(),await this.hydrateFromStorageService(),this._state.versionUID!==s?a=!1:a=!0,e+=1}return this.ready=!0,this.onReadyCallback(this.state),!!a}async create(t,e){const a=e||h(),s=r.generateSubstanceMetadataFromSubstanceJson(t);await n(t,a),await this.conflictRobustStateMutationExecution(()=>{this._state.items[a]=s}),console.info("CREATE",a)}async read(t){const e=await o(t);return this._state.items.hasOwnProperty(t)===!1&&await this.create(e,t),console.info("READ",t),e}async update(t,e){if(this._state.items.hasOwnProperty(t)===!1){await this.create(e,t);return}const a=this._state.items[t],s=r.generateSubstanceMetadataFromSubstanceJson(e);s.created=a.created,await n(e,t),await this.conflictRobustStateMutationExecution(()=>{this._state.items[t]=s}),console.info("UPDATE",t)}async delete(t){await this.conflictRobustStateMutationExecution(()=>{delete this._state.items[t]}),console.info("DELETE",t)}dirtyState(){this.stringifiedState=""}stringify(){return this.stringifiedState||(this.stringifiedState=JSON.stringify(this._state)),this.stringifiedState}get state(){return JSON.parse(this.stringify())}}const l="CARGO_PACK_INDEX";class i{constructor(t=()=>{}){this._state={versionUID:"",items:{}},this.stringifiedState="",this.ready=!1,this.onReadyPendingCallbacks=[],this.onReadyCallback=t,this.hydrateFromStorageService().then(()=>{this.handleNewValidState()})}static getTagsFromPackJson(t){return t.tags||[]}static getExtraThumbnailsFromPackJson(t){return t.extraThumbnails||[]}static getAuthorFromPackJson(t){return t.author||""}static getToolFromPackJson(t){return t.tool||""}static getNameFromPackJson(t){return t.name||""}static getThumbnailFromPackJson(t){return t.thumbnail?t.thumbnail.split("/image/").pop():""}static generatePackMetadataFromPackJson(t){return{thumbnail:i.getThumbnailFromPackJson(t),author:i.getAuthorFromPackJson(t),tool:i.getToolFromPackJson(t),name:i.getNameFromPackJson(t),created:Date.now(),modified:Date.now(),tags:i.getTagsFromPackJson(t),extraThumbnails:i.getExtraThumbnailsFromPackJson(t)}}handleNewValidState(){for(this.ready=!0,this.onReadyCallback(this.state);this.onReadyPendingCallbacks.length>0;)this.onReadyPendingCallbacks.pop()(this.state)}async isReady(){if(!this.ready)return new Promise(t=>{this.onReadyPendingCallbacks.push(t)})}async hydrateFromStorageService(){const t=await o(l);this._state=t,this.dirtyState()}async saveStateToStorageService(){return await n(this.state,l)}async conflictRobustStateMutationExecution(t){let e=0,a=!1;for(this.ready=!1,await this.hydrateFromStorageService();!a&&e<10;){const s=h();this._state.versionUID=s,t(),this.dirtyState(),await this.saveStateToStorageService(),await this.hydrateFromStorageService(),this._state.versionUID!==s?a=!1:a=!0,e+=1}return this.handleNewValidState(),!!a}async create(t,e){const a=e||h(),s=i.generatePackMetadataFromPackJson(t);return await n(t,a),await this.conflictRobustStateMutationExecution(()=>{this._state.items[a]=s}),a}async read(t){await this.isReady();const e=await o(t);return this._state.items.hasOwnProperty(t)===!1&&(e&&e.id===t?await this.create(e,t):console.info("FAILED TO READ PACK")),e}async update(t,e){if(this._state.items.hasOwnProperty(t)===!1){await this.create(e,t);return}const a=this._state.items[t],s=i.generatePackMetadataFromPackJson(e);s.created=a.created,await n(e,t),await this.conflictRobustStateMutationExecution(()=>{this._state.items[t]=s}),console.info("UPDATE",t)}async delete(t){await this.conflictRobustStateMutationExecution(()=>{delete this._state.items[t]}),await u(t),console.info("DELETE",t)}dirtyState(){this.stringifiedState=""}stringify(){return this.stringifiedState||(this.stringifiedState=JSON.stringify(this._state)),this.stringifiedState}get state(){return JSON.parse(this.stringify())}}export{i as C,r as S};
