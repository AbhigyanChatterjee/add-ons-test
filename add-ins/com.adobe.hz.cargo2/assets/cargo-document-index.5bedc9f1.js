const v=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function e(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerpolicy&&(s.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?s.credentials="include":a.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(a){if(a.ep)return;a.ep=!0;const s=e(a);fetch(a.href,s)}};v();function w(){return Math.random().toString(36).substring(7)}const E=document.createElement("canvas");E.getContext("2d");function F(i){const t=atob(i.split(",")[1]),e=i.split(",")[0].split(":")[1].split(";")[0],n=new ArrayBuffer(t.length),a=new Uint8Array(n);for(let s=0;s<t.length;s++)a[s]=t.charCodeAt(s);return new Blob([n],{type:e})}const $=document.createElement("canvas"),b=$.getContext("2d"),O=100,p=new Map;function j(i,t,e="normal",n="normal"){return b.font=`${n} ${e} 100px ${t}`,i.map(a=>{const s=`${t}:${e}:${n}:${a}`;return p.has(s)||p.set(s,b.measureText(a).width/O),p.get(s)})}const h="https://cargodataserver-dev-va6.stage.cloud.adobe.io",d=document.createElement("canvas"),c=d.getContext("2d"),R=200*200,A="_sm.png";function x(){return crypto.getRandomValues(new Uint32Array(3)).join("")}async function L(i){return new Promise(t=>{const e=new Image;e.onload=()=>{const n=e.naturalWidth/e.naturalHeight,a=Math.sqrt(R/n),s=n*a,o=Math.round(a),u=Math.round(s);c==null||c.clearRect(0,0,d.width,d.height),d.width=u,d.height=o,c==null||c.drawImage(e,0,0,u,o),d.toBlob(g=>{t(g),URL.revokeObjectURL(e.src)})},e.src=URL.createObjectURL(i)})}async function T(i,t){const e=new FormData;e.append("file",i,t);const n=await fetch(`${h}/image/upload`,{method:"POST",body:e});let a={};try{a=await n.json()}catch(s){console.info("failed to get valid json from upload request",s)}if(a&&a.status==="ok"){const s=a.result[0].image;return{id:s.id,url:`${h}/image/${s.id}`,width:parseInt(s.width,10),height:parseInt(s.height,10),format:s.format}}return a}async function U(i,t){const e=`${t}${A}`,n=await L(i);await T(n,e)}async function N(i){const t=typeof i=="string"?F(i):i,e=x(),n=`${e}.png`,a=await T(t,n);return console.log("start thumb"),await U(t,e),console.log("end thumb"),a}async function m(i){const t={cache:"no-store"};let e={};const n=await fetch(`${h}/data/${i}?redir=1`,t);try{e=await n.json()}catch(a){console.info("Did not fetch a valid object for id",i,a),e={}}return e}async function P(i){return await m(i)}async function y(i,t){const e=new Headers;e.append("Content-Type","application/json");const n=JSON.stringify(i),a={method:"POST",headers:e,body:n,redirect:"follow",cache:"no-store"};return await(await fetch(`${h}/data/${t}`,a)).text()}async function K(i){const t={method:"DELETE",redirect:"follow"};return await fetch(`${h}/data/${i}`,t)}async function M(i){const t=await P(i);!t||!t.nodes||await K(i)}async function C(i){const t=await m(i);return`${h}/data/${t.archive}`}const f=document.createElement("canvas"),l=f.getContext("2d");async function q(i,t,e,n,a,s){if(!l)return"";f.width=300,f.height=300,l.clearRect(0,0,300,300),l.font=`${e} ${t} 200px ${i}`;const o=l.measureText("Ag").width;l.textBaseline="middle",l.fillText("Ag",150-o/2,150);const u=f.toDataURL("image/png"),g=await F(u);return(await N(g)).url}const S="CARGO_DOCUMENT_INDEX";class r{constructor(t=()=>{}){this._state={versionUID:"",items:{}},this.stringifiedState="",this.ready=!1,this.onReadyPendingCallbacks=[],this.onReadyCallback=t,this.hydrateFromStorageService().then(()=>{this.handleNewValidState()})}static getTagsFromKitJson(t){return t.tags||[]}static getExtraThumbnailsFromKitJson(t){return t.extraThumbnails||[]}static getAuthorFromKitJson(t){return t.author||""}static getToolFromKitJson(t){return t.tool||""}static getNameFromKitJson(t){return t.name||""}static getThumbnailFromKitJson(t){return t.thumbnail?t.thumbnail.split("/image/").pop():""}static generateKitMetadataFromKitJson(t){return{thumbnail:r.getThumbnailFromKitJson(t),author:r.getAuthorFromKitJson(t),tool:r.getToolFromKitJson(t),name:r.getNameFromKitJson(t),created:Date.now(),modified:Date.now(),tags:r.getTagsFromKitJson(t),extraThumbnails:r.getExtraThumbnailsFromKitJson(t)}}handleNewValidState(){for(this.ready=!0,this.onReadyCallback(this.state);this.onReadyPendingCallbacks.length>0;)this.onReadyPendingCallbacks.pop()(this.state)}async isReady(){if(!this.ready)return new Promise(t=>{this.onReadyPendingCallbacks.push(t)})}async hydrateFromStorageService(){const t=await m(S);t.items||(t.items={},t.versionUID=""),this._state=t,this.dirtyState()}async saveStateToStorageService(){return await y(this.state,S)}async conflictRobustStateMutationExecution(t){let e=0,n=!1;for(this.ready=!1,await this.hydrateFromStorageService();!n&&e<10;){const a=w();this._state.versionUID=a,t(),this.dirtyState(),await this.saveStateToStorageService(),await this.hydrateFromStorageService(),this._state.versionUID!==a?n=!1:n=!0,e+=1}return this.handleNewValidState(),!!n}async create(t,e){const n=e||w(),a=r.generateKitMetadataFromKitJson(t);await y(t,n),await this.conflictRobustStateMutationExecution(()=>{this._state.items[n]=a}),console.info("CREATE",n)}async read(t){await this.isReady();const e=await m(t);return this._state.items.hasOwnProperty(t)===!1&&(e&&e.id===t?await this.create(e,t):console.info("FAILED TO READ KIT")),e}async update(t,e){if(this._state.items.hasOwnProperty(t)===!1){await this.create(e,t);return}const n=this._state.items[t],a=r.generateKitMetadataFromKitJson(e);a.created=n.created,await y(e,t),await this.conflictRobustStateMutationExecution(()=>{this._state.items[t]=a}),console.info("UPDATE",t)}async delete(t){await this.conflictRobustStateMutationExecution(()=>{delete this._state.items[t]}),await M(t),console.info("DELETE",t)}dirtyState(){this.stringifiedState=""}stringify(){return this.stringifiedState||(this.stringifiedState=JSON.stringify(this._state)),this.stringifiedState}get state(){return JSON.parse(this.stringify())}}export{h as A,r as C,m as a,q as b,U as c,F as d,K as e,C as g,y as p,w as r,j as t,N as u};
